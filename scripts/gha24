#!/bin/bash
set -euo pipefail

# GHA24 - Submit task to FUGUE Tutti (6-parallel agent consensus)
# Usage: gha24 "task description" [--implement] [--repo owner/repo]
#
# Options:
#   --implement    Add codex-implement label to trigger Codex CLI code generation
#   --repo REPO    Target repository to operate on (default: cursorvers/fugue-orchestrator)
#
# Notes:
#   The issue is always created in the orchestrator repo. The target repo is
#   passed via the issue body so the caller workflow can resolve it.

TASK=""
ORCHESTRATOR_REPO="${GHA24_ORCHESTRATOR_REPO:-cursorvers/fugue-orchestrator}"
TARGET_REPO="cursorvers/fugue-orchestrator"
IMPLEMENT=false

while [[ $# -gt 0 ]]; do
  case "${1}" in
    --implement)
      IMPLEMENT=true
      shift
      ;;
    --repo)
      TARGET_REPO="${2}"
      shift 2
      ;;
    -h|--help)
      echo "Usage: gha24 \"task description\" [--implement] [--repo owner/repo]"
      echo ""
      echo "Options:"
      echo "  --implement    Trigger Codex CLI for autonomous code generation"
      echo "  --repo REPO    Target repository (default: cursorvers/fugue-orchestrator)"
      echo ""
      echo "Environment:"
      echo "  GHA24_ORCHESTRATOR_REPO  Orchestrator repo for issue creation (default: cursorvers/fugue-orchestrator)"
      echo ""
      echo "Examples:"
      echo "  gha24 \"認証フローのセキュリティレビュー\""
      echo "  gha24 \"Implement auth middleware\" --implement"
      echo "  gha24 \"Review auth flow\" --repo cursorvers/fugue-system-ui"
      echo "  gha24 \"Add tests for utils\" --implement --repo cursorvers/telop-pack-srt-02"
      exit 0
      ;;
    *)
      if [[ -z "${TASK}" ]]; then
        TASK="${1}"
      fi
      shift
      ;;
  esac
done

if [[ -z "${TASK}" ]]; then
  echo "Error: task description required" >&2
  echo "Usage: gha24 \"task description\" [--implement] [--repo owner/repo]"
  exit 1
fi

if ! command -v gh &>/dev/null; then
  echo "Error: gh CLI not found" >&2
  exit 1
fi

LABELS="fugue-task,tutti"
if [[ "${IMPLEMENT}" == "true" ]]; then
  LABELS="${LABELS},codex-implement"
fi

BODY="$(cat <<EOF
## GHA24 Task
${TASK}

## Target repo
\`${TARGET_REPO}\`

## Mode
$( [[ "${IMPLEMENT}" == "true" ]] && echo "implement" || echo "review" )
EOF
)"

URL="$(gh issue create --repo "${ORCHESTRATOR_REPO}" \
  --title "${TASK}" \
  --label "${LABELS}" \
  --body "${BODY}")"

echo "Created: ${URL}"
echo "Orchestrator repo: ${ORCHESTRATOR_REPO}"
echo "Target repo: ${TARGET_REPO}"

if [[ "${IMPLEMENT}" == "true" ]]; then
  echo "Mode: Codex CLI implementation (code generation + PR)"
  echo "Tutti vote will run first. If approved, Codex implement will run automatically."
else
  echo "Mode: Review only (6-parallel agent consensus)"
fi

echo "Check results later:"
echo "  gh issue view ${URL##*/} --repo ${ORCHESTRATOR_REPO} --comments"

#!/bin/bash
set -euo pipefail

# GHA24 - Submit task to FUGUE Tutti (agent consensus)
# Usage: gha24 "task description" [--implement|--review] [--repo owner/repo] [--orchestrator codex|claude] [--force-claude]
#
# Options:
#   --implement    Add implement intent labels to trigger post-vote implementation
#   --review       Force review-only mode (ignore natural language hints)
#   --repo REPO    Target repository to operate on (default: cursorvers/fugue-orchestrator)
#   --orchestrator Per-request orchestrator override (codex|claude)
#   --force-claude Force claude provider for this issue even when repo fallback state is degraded/exhausted
#
# Notes:
#   The issue is always created in the orchestrator repo. The target repo is
#   passed via the issue body so the caller workflow can resolve it.
#
# Secrets strategy:
#   Prefer GitHub Organization secrets (selected repos) over per-repo secrets.
#   Run scripts/audit-org-secrets.sh to verify coverage.

TASK=""
ORCHESTRATOR_REPO="${GHA24_ORCHESTRATOR_REPO:-cursorvers/fugue-orchestrator}"
TARGET_REPO="cursorvers/fugue-orchestrator"
IMPLEMENT=false
MODE_EXPLICIT=false
ORCHESTRATOR_PROVIDER="${GHA24_ORCHESTRATOR_PROVIDER:-}"
ORCHESTRATOR_PROVIDER_EXPLICIT=false
FORCE_CLAUDE=false
if [[ -n "${GHA24_ORCHESTRATOR_PROVIDER:-}" ]]; then
  ORCHESTRATOR_PROVIDER_EXPLICIT=true
fi

while [[ $# -gt 0 ]]; do
  case "${1}" in
    --implement)
      IMPLEMENT=true
      MODE_EXPLICIT=true
      shift
      ;;
    --review)
      IMPLEMENT=false
      MODE_EXPLICIT=true
      shift
      ;;
    --repo)
      TARGET_REPO="${2}"
      shift 2
      ;;
    --orchestrator)
      ORCHESTRATOR_PROVIDER="${2}"
      ORCHESTRATOR_PROVIDER_EXPLICIT=true
      shift 2
      ;;
    --force-claude)
      FORCE_CLAUDE=true
      shift
      ;;
    -h|--help)
      echo "Usage: gha24 \"task description\" [--implement|--review] [--repo owner/repo] [--orchestrator codex|claude] [--force-claude]"
      echo ""
      echo "Options:"
      echo "  --implement    Trigger Codex CLI for autonomous code generation"
      echo "  --review       Review only (no code generation)"
      echo "  --repo REPO    Target repository (default: cursorvers/fugue-orchestrator)"
      echo "  --orchestrator Per-request orchestrator override (codex|claude)"
      echo "  --force-claude Force claude provider for this issue"
      echo ""
      echo "Environment:"
      echo "  GHA24_ORCHESTRATOR_REPO  Orchestrator repo for issue creation (default: cursorvers/fugue-orchestrator)"
      echo "  GHA24_ORCHESTRATOR_PROVIDER  Per-request orchestrator override (codex|claude)"
      echo ""
      echo "Examples:"
      echo "  gha24 \"認証フローのセキュリティレビュー\""
      echo "  gha24 \"実装: auth middleware を追加してPR作成\""
      echo "  gha24 \"レビュー: auth flow をレビューして指摘だけ\""
      echo "  gha24 \"Review auth flow\" --repo cursorvers/fugue-system-ui"
      echo "  gha24 \"Add tests for utils\" --implement --repo cursorvers/telop-pack-srt-02"
      echo "  gha24 \"完遂: API障害対応\" --orchestrator claude"
      echo "  gha24 \"完遂: API障害対応\" --orchestrator claude --force-claude"
      exit 0
      ;;
    *)
      if [[ -z "${TASK}" ]]; then
        TASK="${1}"
      fi
      shift
      ;;
  esac
done

if [[ -z "${TASK}" ]]; then
  echo "Error: task description required" >&2
  echo "Usage: gha24 \"task description\" [--implement|--review] [--repo owner/repo] [--orchestrator codex|claude] [--force-claude]"
  exit 1
fi

if ! command -v gh &>/dev/null; then
  echo "Error: gh CLI not found" >&2
  exit 1
fi

if [[ "${FORCE_CLAUDE}" == "true" && "${ORCHESTRATOR_PROVIDER_EXPLICIT}" != "true" ]]; then
  echo "Error: --force-claude requires --orchestrator claude" >&2
  exit 1
fi

# Natural language mode selection (only when no explicit mode flag was provided).
# Keep this conservative: only opt into implementation when the intent is explicit.
if [[ "${MODE_EXPLICIT}" != "true" ]]; then
  if echo "${TASK}" | grep -Eqi '(レビューのみ|指摘のみ|実装しない|実装不要|review only|no implement|no-implement|#review)'; then
    IMPLEMENT=false
  elif echo "${TASK}" | grep -Eqi '(実装|PR作成|プルリク|自走|full-auto|#implement)'; then
    IMPLEMENT=true
  fi
fi

# Create the issue first, then add the `tutti` label as a second step.
# This avoids multiple `issues:labeled` triggers firing at creation time.
provider=""
if [[ "${ORCHESTRATOR_PROVIDER_EXPLICIT}" == "true" ]]; then
  provider="$(echo "${ORCHESTRATOR_PROVIDER}" | tr '[:upper:]' '[:lower:]' | sed -E 's/^[[:space:]]+|[[:space:]]+$//g')"
  if [[ "${provider}" != "claude" && "${provider}" != "codex" ]]; then
    echo "Error: --orchestrator must be codex or claude" >&2
    exit 1
  fi

  if [[ "${FORCE_CLAUDE}" == "true" && "${provider}" != "claude" ]]; then
    echo "Error: --force-claude requires --orchestrator claude" >&2
    exit 1
  fi

  if [[ "${provider}" == "claude" && "${FORCE_CLAUDE}" != "true" ]]; then
    claude_state="$(gh variable get FUGUE_CLAUDE_RATE_LIMIT_STATE --repo "${ORCHESTRATOR_REPO}" --json value -q '.value' 2>/dev/null || echo "ok")"
    claude_state="$(echo "${claude_state}" | tr '[:upper:]' '[:lower:]' | sed -E 's/^[[:space:]]+|[[:space:]]+$//g')"
    if [[ "${claude_state}" == "degraded" || "${claude_state}" == "exhausted" ]]; then
      echo "Notice: FUGUE_CLAUDE_RATE_LIMIT_STATE=${claude_state}. Auto-fallback to codex applied for this request."
      provider="codex"
    fi
  fi
fi

LABELS="fugue-task"
if [[ "${IMPLEMENT}" == "true" ]]; then
  gh label create "implement" \
    --repo "${ORCHESTRATOR_REPO}" \
    --description "Implementation intent (provider-agnostic)" \
    --color "1D76DB" >/dev/null 2>&1 || true

  # `implement` is the provider-agnostic intent label.
  # Add provider-specific compatibility label only when provider is explicitly chosen.
  LABELS="${LABELS},implement"
  if [[ "${ORCHESTRATOR_PROVIDER_EXPLICIT}" == "true" ]]; then
    compat_label="$( [[ "${provider}" == "claude" ]] && echo "claude-implement" || echo "codex-implement" )"
    gh label create "${compat_label}" \
      --repo "${ORCHESTRATOR_REPO}" \
      --description "Implementation intent compatibility label" \
      --color "0052CC" >/dev/null 2>&1 || true
    LABELS="${LABELS},${compat_label}"
  fi
fi

BODY="$(cat <<EOF
## GHA24 Task
${TASK}

## Spec (minimal)
### Goal
${TASK}

### Must not
- Do not touch unrelated files
- Do not leak secrets
- Do not perform destructive operations (delete/rotate/disable) unless explicitly requested

### Acceptance criteria
- [ ] Change matches Goal
- [ ] No unintended file changes
- [ ] CI/lint/tests pass if present

### Rollback
- Revert the PR

## Target repo
\`${TARGET_REPO}\`

$( if [[ "${ORCHESTRATOR_PROVIDER_EXPLICIT}" == "true" ]]; then cat <<PROVIDER
## Orchestrator provider
${provider}

PROVIDER
fi )

## Mode
$( [[ "${IMPLEMENT}" == "true" ]] && echo "implement" || echo "review" )
EOF
)"

URL="$(gh issue create --repo "${ORCHESTRATOR_REPO}" \
  --title "${TASK}" \
  --label "${LABELS}" \
  --body "${BODY}")"

ISSUE_NUM="${URL##*/}"
if [[ "${ORCHESTRATOR_PROVIDER_EXPLICIT}" == "true" ]]; then
  orchestrator_label="orchestrator:${provider}"
  gh label create "${orchestrator_label}" \
    --repo "${ORCHESTRATOR_REPO}" \
    --description "Requested orchestrator profile for Tutti routing" \
    --color "5319E7" >/dev/null 2>&1 || true
  gh issue edit "${ISSUE_NUM}" --repo "${ORCHESTRATOR_REPO}" --remove-label "orchestrator:claude" --remove-label "orchestrator:codex" >/dev/null 2>&1 || true
  gh issue edit "${ISSUE_NUM}" --repo "${ORCHESTRATOR_REPO}" --add-label "${orchestrator_label}" >/dev/null
  if [[ "${FORCE_CLAUDE}" == "true" ]]; then
    gh label create "orchestrator-force:claude" \
      --repo "${ORCHESTRATOR_REPO}" \
      --description "Force claude orchestrator for this issue (override rate-limit fallback)" \
      --color "B60205" >/dev/null 2>&1 || true
    gh issue edit "${ISSUE_NUM}" --repo "${ORCHESTRATOR_REPO}" --add-label "orchestrator-force:claude" >/dev/null
  fi
fi
gh issue edit "${ISSUE_NUM}" --repo "${ORCHESTRATOR_REPO}" --add-label "tutti" >/dev/null

echo "Created: ${URL}"
echo "Orchestrator repo: ${ORCHESTRATOR_REPO}"
echo "Target repo: ${TARGET_REPO}"
if [[ "${ORCHESTRATOR_PROVIDER_EXPLICIT}" == "true" ]]; then
  echo "Orchestrator profile override: ${provider}"
  if [[ "${FORCE_CLAUDE}" == "true" ]]; then
    echo "Override guard: orchestrator-force:claude enabled"
  fi
else
  echo "Orchestrator profile: repository default (FUGUE_ORCHESTRATOR_PROVIDER)"
fi

if [[ "${IMPLEMENT}" == "true" ]]; then
  echo "Mode: Implementation intent (executed by Codex CLI after Tutti approval)"
  echo "Tutti vote will run first. If approved, Codex implement will run automatically."
else
  echo "Mode: Review only (6-parallel agent consensus)"
fi

echo "Check results later:"
echo "  gh issue view ${URL##*/} --repo ${ORCHESTRATOR_REPO} --comments"

#!/bin/bash
set -euo pipefail

# GHA24 - Submit task to FUGUE Tutti (agent consensus)
# Usage: gha24 "task description" [--implement|--review] [--repo owner/repo]
#
# Options:
#   --implement    Add implement intent labels to trigger post-vote implementation
#   --review       Force review-only mode (ignore natural language hints)
#   --repo REPO    Target repository to operate on (default: cursorvers/fugue-orchestrator)
#
# Notes:
#   The issue is always created in the orchestrator repo. The target repo is
#   passed via the issue body so the caller workflow can resolve it.
#
# Secrets strategy:
#   Prefer GitHub Organization secrets (selected repos) over per-repo secrets.
#   Run scripts/audit-org-secrets.sh to verify coverage.

TASK=""
ORCHESTRATOR_REPO="${GHA24_ORCHESTRATOR_REPO:-cursorvers/fugue-orchestrator}"
TARGET_REPO="cursorvers/fugue-orchestrator"
IMPLEMENT=false
MODE_EXPLICIT=false
ORCHESTRATOR_PROVIDER="${GHA24_ORCHESTRATOR_PROVIDER:-codex}"

while [[ $# -gt 0 ]]; do
  case "${1}" in
    --implement)
      IMPLEMENT=true
      MODE_EXPLICIT=true
      shift
      ;;
    --review)
      IMPLEMENT=false
      MODE_EXPLICIT=true
      shift
      ;;
    --repo)
      TARGET_REPO="${2}"
      shift 2
      ;;
    -h|--help)
      echo "Usage: gha24 \"task description\" [--implement|--review] [--repo owner/repo]"
      echo ""
      echo "Options:"
      echo "  --implement    Trigger Codex CLI for autonomous code generation"
      echo "  --review       Review only (no code generation)"
      echo "  --repo REPO    Target repository (default: cursorvers/fugue-orchestrator)"
      echo ""
      echo "Environment:"
      echo "  GHA24_ORCHESTRATOR_REPO  Orchestrator repo for issue creation (default: cursorvers/fugue-orchestrator)"
      echo ""
      echo "Examples:"
      echo "  gha24 \"認証フローのセキュリティレビュー\""
      echo "  gha24 \"実装: auth middleware を追加してPR作成\""
      echo "  gha24 \"レビュー: auth flow をレビューして指摘だけ\""
      echo "  gha24 \"Review auth flow\" --repo cursorvers/fugue-system-ui"
      echo "  gha24 \"Add tests for utils\" --implement --repo cursorvers/telop-pack-srt-02"
      exit 0
      ;;
    *)
      if [[ -z "${TASK}" ]]; then
        TASK="${1}"
      fi
      shift
      ;;
  esac
done

if [[ -z "${TASK}" ]]; then
  echo "Error: task description required" >&2
  echo "Usage: gha24 \"task description\" [--implement|--review] [--repo owner/repo]"
  exit 1
fi

if ! command -v gh &>/dev/null; then
  echo "Error: gh CLI not found" >&2
  exit 1
fi

# Natural language mode selection (only when no explicit mode flag was provided).
# Keep this conservative: only opt into implementation when the intent is explicit.
if [[ "${MODE_EXPLICIT}" != "true" ]]; then
  if echo "${TASK}" | grep -Eqi '(レビューのみ|指摘のみ|実装しない|実装不要|review only|no implement|no-implement|#review)'; then
    IMPLEMENT=false
  elif echo "${TASK}" | grep -Eqi '(実装|PR作成|プルリク|自走|full-auto|#implement)'; then
    IMPLEMENT=true
  fi
fi

# Create the issue first, then add the `tutti` label as a second step.
# This avoids multiple `issues:labeled` triggers firing at creation time.
provider="$(echo "${ORCHESTRATOR_PROVIDER}" | tr '[:upper:]' '[:lower:]')"
if [[ "${provider}" != "claude" && "${provider}" != "codex" ]]; then
  provider="codex"
fi
compat_label="$( [[ "${provider}" == "claude" ]] && echo "claude-implement" || echo "codex-implement" )"

LABELS="fugue-task"
if [[ "${IMPLEMENT}" == "true" ]]; then
  gh label create "implement" \
    --repo "${ORCHESTRATOR_REPO}" \
    --description "Implementation intent (provider-agnostic)" \
    --color "1D76DB" >/dev/null 2>&1 || true
  gh label create "${compat_label}" \
    --repo "${ORCHESTRATOR_REPO}" \
    --description "Implementation intent compatibility label" \
    --color "0052CC" >/dev/null 2>&1 || true

  # `implement` is the provider-agnostic intent label.
  # Add a provider-specific compatibility label for existing workflows/tooling.
  LABELS="${LABELS},implement,${compat_label}"
fi

BODY="$(cat <<EOF
## GHA24 Task
${TASK}

## Spec (minimal)
### Goal
${TASK}

### Must not
- Do not touch unrelated files
- Do not leak secrets
- Do not perform destructive operations (delete/rotate/disable) unless explicitly requested

### Acceptance criteria
- [ ] Change matches Goal
- [ ] No unintended file changes
- [ ] CI/lint/tests pass if present

### Rollback
- Revert the PR

## Target repo
\`${TARGET_REPO}\`

## Mode
$( [[ "${IMPLEMENT}" == "true" ]] && echo "implement" || echo "review" )
EOF
)"

URL="$(gh issue create --repo "${ORCHESTRATOR_REPO}" \
  --title "${TASK}" \
  --label "${LABELS}" \
  --body "${BODY}")"

ISSUE_NUM="${URL##*/}"
gh issue edit "${ISSUE_NUM}" --repo "${ORCHESTRATOR_REPO}" --add-label "tutti" >/dev/null

echo "Created: ${URL}"
echo "Orchestrator repo: ${ORCHESTRATOR_REPO}"
echo "Target repo: ${TARGET_REPO}"

if [[ "${IMPLEMENT}" == "true" ]]; then
  echo "Mode: Codex CLI implementation (code generation + PR)"
  echo "Tutti vote will run first. If approved, Codex implement will run automatically."
else
  echo "Mode: Review only (6-parallel agent consensus)"
fi

echo "Check results later:"
echo "  gh issue view ${URL##*/} --repo ${ORCHESTRATOR_REPO} --comments"

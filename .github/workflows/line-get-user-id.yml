name: line-get-user-id (one-time)

on:
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  get-user-id:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: Verify bot and get user ID
        env:
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
        run: |
          set -euo pipefail
          echo "=== Bot Info ==="
          curl -sS https://api.line.me/v2/bot/info \
            -H "Authorization: Bearer ${LINE_CHANNEL_ACCESS_TOKEN}" | jq .

          echo ""
          echo "=== Webhook endpoint config ==="
          curl -sS https://api.line.me/v2/bot/channel/webhook/endpoint \
            -H "Authorization: Bearer ${LINE_CHANNEL_ACCESS_TOKEN}" | jq .

          echo ""
          echo "=== Webhook test ==="
          curl -sS -X POST https://api.line.me/v2/bot/channel/webhook/test \
            -H "Authorization: Bearer ${LINE_CHANNEL_ACCESS_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{"endpoint":"https://haaxgwyimoqzzxzdaeep.supabase.co/functions/v1/line-userid-capture"}' | jq .

          echo ""
          echo "=== Followers ==="
          curl -sS https://api.line.me/v2/bot/followers/ids \
            -H "Authorization: Bearer ${LINE_CHANNEL_ACCESS_TOKEN}" | jq . || true

          echo ""
          echo "=== Message quota ==="
          curl -sS https://api.line.me/v2/bot/message/quota/consumption \
            -H "Authorization: Bearer ${LINE_CHANNEL_ACCESS_TOKEN}" | jq . || true

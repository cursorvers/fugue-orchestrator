name: fugue-watchdog

on:
  schedule:
    - cron: "17 * * * *"
  workflow_dispatch:

permissions:
  issues: write
  actions: read

jobs:
  health:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: API connectivity check
        id: connectivity
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ZAI_API_KEY: ${{ secrets.ZAI_API_KEY }}
        run: |
          set +e
          OPENAI_OK="false"
          ZAI_OK="false"

          curl -fsS https://api.openai.com/v1/models \
            -H "Authorization: Bearer ${OPENAI_API_KEY}" >/dev/null 2>&1
          [[ $? -eq 0 ]] && OPENAI_OK="true"

          curl -fsS https://api.z.ai/api/coding/paas/v4/models \
            -H "Authorization: Bearer ${ZAI_API_KEY}" >/dev/null 2>&1
          [[ $? -eq 0 ]] && ZAI_OK="true"

          {
            echo "openai_ok=${OPENAI_OK}"
            echo "zai_ok=${ZAI_OK}"
          } >> "${GITHUB_OUTPUT}"

      - name: Get latest successful router run
        id: last_success
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          RUNS_JSON="$(gh api "repos/${GITHUB_REPOSITORY}/actions/workflows/fugue-task-router.yml/runs?status=success&per_page=1")"
          LAST_TIME="$(echo "${RUNS_JSON}" | jq -r '.workflow_runs[0].created_at // empty')"

          if [[ -z "${LAST_TIME}" ]]; then
            echo "stale=true" >> "${GITHUB_OUTPUT}"
            echo "hours_since=9999" >> "${GITHUB_OUTPUT}"
            exit 0
          fi

          NOW_EPOCH="$(date -u +%s)"
          LAST_EPOCH="$(date -u -d "${LAST_TIME}" +%s)"
          DIFF_HOURS="$(( (NOW_EPOCH - LAST_EPOCH) / 3600 ))"

          STALE="false"
          if [[ "${DIFF_HOURS}" -ge 3 ]]; then
            STALE="true"
          fi

          {
            echo "stale=${STALE}"
            echo "hours_since=${DIFF_HOURS}"
            echo "last_time=${LAST_TIME}"
          } >> "${GITHUB_OUTPUT}"

      - name: Discord alert when unhealthy
        if: ${{ steps.connectivity.outputs.openai_ok != 'true' || steps.connectivity.outputs.zai_ok != 'true' || steps.last_success.outputs.stale == 'true' }}
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          set -euo pipefail

          MSG="fugue-watchdog alert
          repo: ${GITHUB_REPOSITORY}
          openai_ok: ${{ steps.connectivity.outputs.openai_ok }}
          zai_ok: ${{ steps.connectivity.outputs.zai_ok }}
          router_hours_since_success: ${{ steps.last_success.outputs.hours_since }}
          router_last_success_at: ${{ steps.last_success.outputs.last_time }}"

          PAYLOAD="$(jq -n --arg content "${MSG}" '{content:$content}')"
          curl -fsS -X POST "${DISCORD_WEBHOOK_URL}" \
            -H "Content-Type: application/json" \
            -d "${PAYLOAD}"

  reconcile:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Find unprocessed fugue-task issues
        id: find
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          ISSUES_JSON="$(gh issue list \
            --repo "${GITHUB_REPOSITORY}" \
            --state open \
            --label "fugue-task" \
            --limit 200 \
            --json number,labels)"

          PENDING_JSON="$(echo "${ISSUES_JSON}" | jq -c '[.[] | select((([.labels[].name] | index("processing")) == null) and (([.labels[].name] | index("completed")) == null)) | .number]')"
          COUNT="$(echo "${PENDING_JSON}" | jq 'length')"

          {
            echo "pending_count=${COUNT}"
            echo "pending_json=${PENDING_JSON}"
          } >> "${GITHUB_OUTPUT}"

      - name: Restart task-router via repository_dispatch
        if: ${{ steps.find.outputs.pending_count != '0' }}
        env:
          GH_TOKEN: ${{ github.token }}
          PENDING_JSON: ${{ steps.find.outputs.pending_json }}
        run: |
          set -euo pipefail

          DISPATCH_PAYLOAD="$(jq -n \
            --arg event_type "fugue-task-reconcile" \
            --argjson issues "${PENDING_JSON}" \
            '{event_type:$event_type, client_payload:{issue_numbers:$issues}}')"

          echo "${DISPATCH_PAYLOAD}" | gh api "repos/${GITHUB_REPOSITORY}/dispatches" \
            -X POST \
            --input -

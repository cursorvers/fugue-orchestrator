name: fugue-orchestrator-canary

on:
  schedule:
    - cron: "43 2 * * *"
  workflow_dispatch:

permissions:
  issues: write
  contents: read
  actions: write

jobs:
  canary:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    env:
      CLAUDE_RATE_LIMIT_STATE: ${{ vars.FUGUE_CLAUDE_RATE_LIMIT_STATE || 'ok' }}
      CLAUDE_ROLE_POLICY: ${{ vars.FUGUE_CLAUDE_ROLE_POLICY || 'flex' }}
      CLAUDE_DEGRADED_ASSIST_POLICY: ${{ vars.FUGUE_CLAUDE_DEGRADED_ASSIST_POLICY || 'claude' }}
      CLAUDE_MAIN_ASSIST_POLICY: ${{ vars.FUGUE_CLAUDE_MAIN_ASSIST_POLICY || 'codex' }}
      CI_EXECUTION_ENGINE: ${{ vars.FUGUE_CI_EXECUTION_ENGINE || 'subscription' }}
      SUBSCRIPTION_OFFLINE_POLICY: ${{ vars.FUGUE_SUBSCRIPTION_OFFLINE_POLICY || 'hold' }}
      EMERGENCY_CONTINUITY_MODE: ${{ vars.FUGUE_EMERGENCY_CONTINUITY_MODE || 'false' }}
      SUBSCRIPTION_RUNNER_LABEL: ${{ vars.FUGUE_SUBSCRIPTION_RUNNER_LABEL || 'fugue-subscription' }}
      EMERGENCY_ASSIST_POLICY: ${{ vars.FUGUE_EMERGENCY_ASSIST_POLICY || 'none' }}
      API_STRICT_MODE: ${{ vars.FUGUE_API_STRICT_MODE || 'false' }}
      HAS_ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY != '' }}
      HAS_OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY != '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run canary (regular + forced claude)
        env:
          GH_TOKEN: ${{ github.token }}
          OPS_TOKEN: ${{ secrets.FUGUE_OPS_PAT || secrets.TARGET_REPO_PAT || '' }}
        run: |
          set -euo pipefail
          gh_api_retry() {
            local endpoint="$1"
            local attempts="${2:-5}"
            local sleep_sec=2
            local i out
            for ((i=1; i<=attempts; i++)); do
              if out="$(gh api "${endpoint}" 2>/dev/null)"; then
                printf '%s\n' "${out}"
                return 0
              fi
              if (( i == attempts )); then
                return 1
              fi
              sleep "${sleep_sec}"
              if (( sleep_sec < 16 )); then
                sleep_sec=$((sleep_sec * 2))
              fi
            done
            return 1
          }

          if [[ -n "${OPS_TOKEN:-}" ]]; then
            GH_TOKEN="${OPS_TOKEN}"
            export GH_TOKEN
          else
            echo "Skip canary: neither FUGUE_OPS_PAT nor TARGET_REPO_PAT is configured; real-issue trust gate cannot pass with github-actions author."
            exit 0
          fi

          repo="${GITHUB_REPOSITORY}"
          ts="$(date -u +%Y%m%d%H%M%S)"
          failures=0
          online_count=0
          self_hosted_online="false"

          normalize() {
            echo "$1" | tr '[:upper:]' '[:lower:]' | sed -E 's/^[[:space:]]+|[[:space:]]+$//g'
          }

          claude_state="$(normalize "${CLAUDE_RATE_LIMIT_STATE:-ok}")"
          role_policy="$(normalize "${CLAUDE_ROLE_POLICY:-flex}")"
          degraded_assist_policy="$(normalize "${CLAUDE_DEGRADED_ASSIST_POLICY:-claude}")"
          main_assist_policy="$(normalize "${CLAUDE_MAIN_ASSIST_POLICY:-codex}")"
          ci_execution_engine="$(normalize "${CI_EXECUTION_ENGINE:-subscription}")"
          if [[ "${ci_execution_engine}" != "subscription" && "${ci_execution_engine}" != "harness" && "${ci_execution_engine}" != "api" ]]; then
            ci_execution_engine="subscription"
          fi
          subscription_offline_policy="$(normalize "${SUBSCRIPTION_OFFLINE_POLICY:-hold}")"
          if [[ "${subscription_offline_policy}" != "hold" && "${subscription_offline_policy}" != "continuity" ]]; then
            subscription_offline_policy="hold"
          fi
          emergency_continuity_mode="$(normalize "${EMERGENCY_CONTINUITY_MODE:-false}")"
          if [[ "${emergency_continuity_mode}" != "true" ]]; then
            emergency_continuity_mode="false"
          fi
          subscription_runner_label="$(echo "${SUBSCRIPTION_RUNNER_LABEL:-fugue-subscription}" | sed -E 's/^[[:space:]]+|[[:space:]]+$//g')"
          if [[ -z "${subscription_runner_label}" ]]; then
            subscription_runner_label="fugue-subscription"
          fi

          if [[ "${ci_execution_engine}" == "subscription" ]]; then
            runners_json="$(gh_api_retry "repos/${repo}/actions/runners?per_page=100" 5 || echo '{}')"
            online_count="$(echo "${runners_json}" | jq -r --arg label "${subscription_runner_label}" '[.runners[]? | select(.status=="online" and .busy != true and ([.labels[]?.name] | index("self-hosted") != null) and ([.labels[]?.name] | index($label) != null))] | length' 2>/dev/null || echo "0")"
            online_count="$(echo "${online_count}" | tr -cd '0-9')"
            if [[ -z "${online_count}" ]]; then
              online_count="0"
            else
              online_count="$((10#${online_count}))"
            fi
            if [[ "${subscription_offline_policy}" == "hold" ]] && (( online_count == 0 )); then
              echo "Canary skipped: subscription strict hold policy active and no online self-hosted runner for label ${subscription_runner_label}."
              exit 0
            fi
          fi
          if (( online_count > 0 )); then
            self_hosted_online="true"
          fi

          eval "$(
            ./scripts/lib/orchestrator-policy.sh \
              --main "claude" \
              --assist "claude" \
              --default-main "codex" \
              --default-assist "claude" \
              --claude-state "${claude_state}" \
              --force-claude "false" \
              --assist-policy "${main_assist_policy}" \
              --claude-role-policy "${role_policy}" \
              --degraded-assist-policy "${degraded_assist_policy}"
          )"
          expected_regular_main="${resolved_main}"
          expected_regular_assist="${resolved_assist}"
          eval "$(
            ./scripts/lib/execution-profile-policy.sh \
              --requested-engine "${ci_execution_engine}" \
              --main-provider "${expected_regular_main}" \
              --assist-provider "${expected_regular_assist}" \
              --force-claude "false" \
              --self-hosted-online "${self_hosted_online}" \
              --claude-state "${claude_state}" \
              --strict-main-requested "true" \
              --strict-opus-requested "true" \
              --claude-direct-available "${HAS_ANTHROPIC_API_KEY}" \
              --codex-api-available "${HAS_OPENAI_API_KEY}" \
              --subscription-offline-policy "${subscription_offline_policy}" \
              --api-strict-mode "${API_STRICT_MODE:-false}" \
              --emergency-continuity-mode "${emergency_continuity_mode}" \
              --emergency-assist-policy "${EMERGENCY_ASSIST_POLICY:-none}"
          )"
          expected_regular_assist_effective="${assist_provider_effective}"
          expected_regular_profile="${execution_profile}"
          expected_regular_runner="${run_agents_runner}"

          eval "$(
            ./scripts/lib/orchestrator-policy.sh \
              --main "claude" \
              --assist "claude" \
              --default-main "codex" \
              --default-assist "claude" \
              --claude-state "${claude_state}" \
              --force-claude "true" \
              --assist-policy "${main_assist_policy}" \
              --claude-role-policy "${role_policy}" \
              --degraded-assist-policy "${degraded_assist_policy}"
          )"
          expected_force_main="${resolved_main}"
          expected_force_assist="${resolved_assist}"
          eval "$(
            ./scripts/lib/execution-profile-policy.sh \
              --requested-engine "${ci_execution_engine}" \
              --main-provider "${expected_force_main}" \
              --assist-provider "${expected_force_assist}" \
              --force-claude "true" \
              --self-hosted-online "${self_hosted_online}" \
              --claude-state "${claude_state}" \
              --strict-main-requested "true" \
              --strict-opus-requested "true" \
              --claude-direct-available "${HAS_ANTHROPIC_API_KEY}" \
              --codex-api-available "${HAS_OPENAI_API_KEY}" \
              --subscription-offline-policy "${subscription_offline_policy}" \
              --api-strict-mode "${API_STRICT_MODE:-false}" \
              --emergency-continuity-mode "${emergency_continuity_mode}" \
              --emergency-assist-policy "${EMERGENCY_ASSIST_POLICY:-none}"
          )"
          expected_force_assist_effective="${assist_provider_effective}"
          expected_force_profile="${execution_profile}"
          expected_force_runner="${run_agents_runner}"

          gh label create "orchestrator:claude" --repo "${repo}" --description "Requested orchestrator profile for Tutti routing" --color "5319E7" >/dev/null 2>&1 || true
          gh label create "orchestrator-assist:claude" --repo "${repo}" --description "Requested assist orchestrator profile for Tutti routing" --color "0052CC" >/dev/null 2>&1 || true
          gh label create "orchestrator-force:claude" --repo "${repo}" --description "Force claude orchestrator for this issue (override rate-limit fallback)" --color "B60205" >/dev/null 2>&1 || true
          gh label create "completed" --repo "${repo}" --description "Processing completed" --color "0E8A16" >/dev/null 2>&1 || true
          gh label create "needs-human" --repo "${repo}" --description "Human intervention required" --color "D93F0B" >/dev/null 2>&1 || true

          create_issue() {
            local title="$1"
            local force_label="$2"
            local body
            body="$(printf '## Canary\nAutomated orchestration canary.\n\n- profile: codex main + claude assist default\n- case: %s\n- created_at_utc: %s\n- cleanup: auto-close on pass, keep open on failure\n' \
              "${title}" \
              "$(date -u +"%Y-%m-%dT%H:%M:%SZ")")"

            local cmd=(gh issue create --repo "${repo}" --title "${title}" --body "${body}" \
              --label "fugue-task" \
              --label "orchestrator:claude" \
              --label "orchestrator-assist:claude")
            if [[ -n "${force_label}" ]]; then
              cmd+=(--label "${force_label}")
            fi
            local url
            url="$("${cmd[@]}")"
            local issue_num="${url##*/}"
            gh issue edit "${issue_num}" --repo "${repo}" --add-label "tutti" >/dev/null
            gh workflow run fugue-tutti-caller.yml \
              --repo "${repo}" \
              -f issue_number="${issue_num}" >/dev/null
            echo "${issue_num}"
          }

          wait_for_resolved_orchestrators() {
            local issue_num="$1"
            local max_attempts=45
            local sleep_sec=20
            local attempt=1
            local comments_json meta_json comment
            while [[ "${attempt}" -le "${max_attempts}" ]]; do
              comments_json="$(gh_api_retry "repos/${repo}/issues/${issue_num}/comments?per_page=100" 4 || echo '[]')"
              meta_json="$(echo "${comments_json}" | jq -r '
                [ .[]?.body
                  | select(contains("FUGUE_INTEGRATED_META:"))
                  | capture("FUGUE_INTEGRATED_META:(?<json>\\{.*\\})").json
                ] | last // ""
              ' 2>/dev/null || echo "")"
              if [[ -n "${meta_json}" ]] && echo "${meta_json}" | jq -e . >/dev/null 2>&1; then
                resolved_main="$(echo "${meta_json}" | jq -r '.main_orchestrator_resolved // ""' | tr '[:upper:]' '[:lower:]')"
                resolved_assist="$(echo "${meta_json}" | jq -r '.assist_orchestrator_resolved // ""' | tr '[:upper:]' '[:lower:]')"
                resolved_profile="$(echo "${meta_json}" | jq -r '.execution_profile // ""' | tr '[:upper:]' '[:lower:]')"
                resolved_runner="$(echo "${meta_json}" | jq -r '.run_agents_runner // ""' | tr '[:upper:]' '[:lower:]')"
                resolved_runner_labels="$(echo "${meta_json}" | jq -c '.run_agents_runner_labels // []')"
                resolved_lanes="$(echo "${meta_json}" | jq -r '.lanes_configured // ""' | tr -cd '0-9')"
                if [[ -n "${resolved_main}" && -n "${resolved_assist}" && -n "${resolved_profile}" ]]; then
                  echo "${resolved_main}|${resolved_assist}|${resolved_profile}|${resolved_runner}|${resolved_runner_labels}|${resolved_lanes}"
                  return 0
                fi
              fi
              comment="$(echo "${comments_json}" | jq -r '[.[].body | select(contains("## Tutti Integrated Review"))] | last // ""')"
              if [[ -n "${comment}" ]]; then
                resolved_main="$(printf '%s\n' "${comment}" | sed -n 's/^- main orchestrator resolved: //p' | head -n1 | tr -d '\r' | tr '[:upper:]' '[:lower:]')"
                resolved_assist="$(printf '%s\n' "${comment}" | sed -n 's/^- assist orchestrator resolved: //p' | head -n1 | tr -d '\r' | tr '[:upper:]' '[:lower:]')"
                resolved_profile="$(printf '%s\n' "${comment}" | sed -n 's/^- execution profile: \([^ ]*\).*/\1/p' | head -n1 | tr -d '\r' | tr '[:upper:]' '[:lower:]')"
                resolved_runner="$(printf '%s\n' "${comment}" | sed -n 's/^- run-agents runner: //p' | head -n1 | tr -d '\r' | tr '[:upper:]' '[:lower:]')"
                resolved_runner_labels="$(printf '%s\n' "${comment}" | sed -n 's/^- run-agents runner labels: //p' | head -n1 | tr -d '\r')"
                resolved_lanes="$(printf '%s\n' "${comment}" | sed -n 's/^- lanes configured: //p' | head -n1 | tr -cd '0-9')"
                if [[ -n "${resolved_main}" && -n "${resolved_assist}" && -n "${resolved_profile}" ]]; then
                  echo "${resolved_main}|${resolved_assist}|${resolved_profile}|${resolved_runner}|${resolved_runner_labels}|${resolved_lanes}"
                  return 0
                fi
              fi
              sleep "${sleep_sec}"
              attempt="$((attempt + 1))"
            done
            return 1
          }

          conclude_issue() {
            local issue_num="$1"
            local expected_main="$2"
            local expected_assist="$3"
            local expected_profile="$4"
            local expected_runner="$5"
            local actual_main="$6"
            local actual_assist="$7"
            local actual_profile="$8"
            local actual_runner="$9"
            local actual_lanes="${10}"
            local pass="${11}"
            local case_name="${12}"
            local reason="${13}"
            local issue_state=""
            local issue_state_after=""
            if [[ "${pass}" == "true" ]]; then
              gh issue comment "${issue_num}" --repo "${repo}" --body "Canary pass (${case_name}): expected main=\`${expected_main}\` assist=\`${expected_assist}\` profile=\`${expected_profile}\` runner=\`${expected_runner}\`, actual main=\`${actual_main}\` assist=\`${actual_assist}\` profile=\`${actual_profile}\` runner=\`${actual_runner}\`, lanes=\`${actual_lanes}\`."
              if ! gh issue edit "${issue_num}" --repo "${repo}" --add-label "completed" >/dev/null 2>&1; then
                echo "Warning: failed to add completed label to issue #${issue_num}" >&2
              fi
              issue_state="$(gh issue view "${issue_num}" --repo "${repo}" --json state -q '.state' 2>/dev/null || true)"
              if [[ "${issue_state}" == "OPEN" ]]; then
                if ! gh issue close "${issue_num}" --repo "${repo}" --comment "Canary cleanup: closed automatically after successful verification." >/dev/null 2>&1; then
                  issue_state_after="$(gh issue view "${issue_num}" --repo "${repo}" --json state -q '.state' 2>/dev/null || true)"
                  if [[ "${issue_state_after}" != "CLOSED" ]]; then
                    echo "Warning: failed to close issue #${issue_num} during canary cleanup." >&2
                  fi
                fi
              fi
            else
              gh issue comment "${issue_num}" --repo "${repo}" --body "Canary fail (${case_name}): expected main=\`${expected_main}\` assist=\`${expected_assist}\` profile=\`${expected_profile}\` runner=\`${expected_runner}\`, actual main=\`${actual_main:-timeout}\` assist=\`${actual_assist:-timeout}\` profile=\`${actual_profile:-timeout}\` runner=\`${actual_runner:-timeout}\`, lanes=\`${actual_lanes:-timeout}\`, reason=\`${reason}\`. Investigate router/caller policy."
              if ! gh issue edit "${issue_num}" --repo "${repo}" --add-label "needs-human" >/dev/null 2>&1; then
                echo "Warning: failed to add needs-human label to issue #${issue_num}" >&2
              fi
            fi
          }

          strict_expected="false"
          if [[ "${ci_execution_engine}" == "subscription" && "${online_count}" -gt 0 ]]; then
            strict_expected="true"
          fi

          regular_issue="$(create_issue "[canary] regular claude request ${ts}" "")"
          force_issue="$(create_issue "[canary] forced claude request ${ts}" "orchestrator-force:claude")"

          regular_pair=""
          if regular_pair="$(wait_for_resolved_orchestrators "${regular_issue}")"; then
            regular_main="${regular_pair%%|*}"
            regular_rest="${regular_pair#*|}"
            regular_assist="${regular_rest%%|*}"
            regular_rest="${regular_rest#*|}"
            regular_profile="${regular_rest%%|*}"
            regular_rest="${regular_rest#*|}"
            regular_runner="${regular_rest%%|*}"
            regular_rest="${regular_rest#*|}"
            regular_runner_labels="${regular_rest%%|*}"
            regular_lanes="${regular_rest#*|}"
            regular_ok="true"
            regular_reason="ok"
            if [[ "${regular_main}" != "${expected_regular_main}" || "${regular_assist}" != "${expected_regular_assist_effective}" ]]; then
              regular_ok="false"
              regular_reason="resolved-provider-mismatch"
            elif [[ "${regular_profile}" != "${expected_regular_profile}" ]]; then
              regular_ok="false"
              regular_reason="execution-profile-mismatch"
            elif [[ "${regular_runner}" != "${expected_regular_runner}" ]]; then
              regular_ok="false"
              regular_reason="runner-mismatch"
            elif [[ "${expected_regular_runner}" == "self-hosted" && "${regular_runner_labels}" != *"\"${subscription_runner_label}\""* ]]; then
              regular_ok="false"
              regular_reason="required-runner-label-missing"
            elif [[ -z "${regular_lanes}" || "${regular_lanes}" == "0" ]]; then
              regular_ok="false"
              regular_reason="lanes-not-materialized"
            fi
            if [[ "${regular_ok}" == "true" ]]; then
              conclude_issue "${regular_issue}" "${expected_regular_main}" "${expected_regular_assist_effective}" "${expected_regular_profile}" "${expected_regular_runner}" "${regular_main}" "${regular_assist}" "${regular_profile}" "${regular_runner}" "${regular_lanes}" "true" "regular" "ok"
            else
              conclude_issue "${regular_issue}" "${expected_regular_main}" "${expected_regular_assist_effective}" "${expected_regular_profile}" "${expected_regular_runner}" "${regular_main}" "${regular_assist}" "${regular_profile}" "${regular_runner}" "${regular_lanes}" "false" "regular" "${regular_reason}"
              failures="$((failures + 1))"
            fi
          else
            conclude_issue "${regular_issue}" "${expected_regular_main}" "${expected_regular_assist_effective}" "${expected_regular_profile}" "${expected_regular_runner}" "" "" "" "" "" "" "false" "regular" "timeout-no-integrated-review"
            failures="$((failures + 1))"
          fi

          force_pair=""
          if force_pair="$(wait_for_resolved_orchestrators "${force_issue}")"; then
            force_main="${force_pair%%|*}"
            force_rest="${force_pair#*|}"
            force_assist="${force_rest%%|*}"
            force_rest="${force_rest#*|}"
            force_profile="${force_rest%%|*}"
            force_rest="${force_rest#*|}"
            force_runner="${force_rest%%|*}"
            force_rest="${force_rest#*|}"
            force_runner_labels="${force_rest%%|*}"
            force_lanes="${force_rest#*|}"
            force_ok="true"
            force_reason="ok"
            if [[ "${force_main}" != "${expected_force_main}" || "${force_assist}" != "${expected_force_assist_effective}" ]]; then
              force_ok="false"
              force_reason="resolved-provider-mismatch"
            elif [[ "${force_profile}" != "${expected_force_profile}" ]]; then
              force_ok="false"
              force_reason="execution-profile-mismatch"
            elif [[ "${force_runner}" != "${expected_force_runner}" ]]; then
              force_ok="false"
              force_reason="runner-mismatch"
            elif [[ "${expected_force_runner}" == "self-hosted" && "${force_runner_labels}" != *"\"${subscription_runner_label}\""* ]]; then
              force_ok="false"
              force_reason="required-runner-label-missing"
            elif [[ -z "${force_lanes}" || "${force_lanes}" == "0" ]]; then
              force_ok="false"
              force_reason="lanes-not-materialized"
            fi
            if [[ "${force_ok}" == "true" ]]; then
              conclude_issue "${force_issue}" "${expected_force_main}" "${expected_force_assist_effective}" "${expected_force_profile}" "${expected_force_runner}" "${force_main}" "${force_assist}" "${force_profile}" "${force_runner}" "${force_lanes}" "true" "force" "ok"
            else
              conclude_issue "${force_issue}" "${expected_force_main}" "${expected_force_assist_effective}" "${expected_force_profile}" "${expected_force_runner}" "${force_main}" "${force_assist}" "${force_profile}" "${force_runner}" "${force_lanes}" "false" "force" "${force_reason}"
              failures="$((failures + 1))"
            fi
          else
            conclude_issue "${force_issue}" "${expected_force_main}" "${expected_force_assist_effective}" "${expected_force_profile}" "${expected_force_runner}" "" "" "" "" "" "" "false" "force" "timeout-no-integrated-review"
            failures="$((failures + 1))"
          fi

          if [[ "${failures}" -gt 0 ]]; then
            echo "Canary failed: ${failures} case(s)"
            exit 1
          fi

          echo "Canary passed: regular(main=${expected_regular_main},assist_effective=${expected_regular_assist_effective},profile=${expected_regular_profile},runner=${expected_regular_runner}), force(main=${expected_force_main},assist_effective=${expected_force_assist_effective},profile=${expected_force_profile},runner=${expected_force_runner}), strict_expected=${strict_expected}"

name: fugue-orchestrator-canary

on:
  schedule:
    - cron: "43 2 * * *"
  workflow_dispatch:

permissions:
  issues: write
  contents: read
  actions: write

jobs:
  canary:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    env:
      CLAUDE_RATE_LIMIT_STATE: ${{ vars.FUGUE_CLAUDE_RATE_LIMIT_STATE || 'ok' }}
      CLAUDE_ROLE_POLICY: ${{ vars.FUGUE_CLAUDE_ROLE_POLICY || 'flex' }}
      CLAUDE_DEGRADED_ASSIST_POLICY: ${{ vars.FUGUE_CLAUDE_DEGRADED_ASSIST_POLICY || 'claude' }}
      CLAUDE_MAIN_ASSIST_POLICY: ${{ vars.FUGUE_CLAUDE_MAIN_ASSIST_POLICY || 'codex' }}
      CI_EXECUTION_ENGINE: ${{ vars.FUGUE_CI_EXECUTION_ENGINE || 'subscription' }}
      SUBSCRIPTION_OFFLINE_POLICY: ${{ vars.FUGUE_SUBSCRIPTION_OFFLINE_POLICY || 'hold' }}
      SUBSCRIPTION_RUNNER_LABEL: ${{ vars.FUGUE_SUBSCRIPTION_RUNNER_LABEL || 'fugue-subscription' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run canary (regular + forced claude)
        env:
          GH_TOKEN: ${{ github.token }}
          OPS_TOKEN: ${{ secrets.FUGUE_OPS_PAT || secrets.TARGET_REPO_PAT || '' }}
        run: |
          set -euo pipefail

          if [[ -n "${OPS_TOKEN:-}" ]]; then
            GH_TOKEN="${OPS_TOKEN}"
            export GH_TOKEN
          else
            echo "Skip canary: neither FUGUE_OPS_PAT nor TARGET_REPO_PAT is configured; real-issue trust gate cannot pass with github-actions author."
            exit 0
          fi

          repo="${GITHUB_REPOSITORY}"
          ts="$(date -u +%Y%m%d%H%M%S)"
          failures=0

          normalize() {
            echo "$1" | tr '[:upper:]' '[:lower:]' | sed -E 's/^[[:space:]]+|[[:space:]]+$//g'
          }

          claude_state="$(normalize "${CLAUDE_RATE_LIMIT_STATE:-ok}")"
          role_policy="$(normalize "${CLAUDE_ROLE_POLICY:-flex}")"
          degraded_assist_policy="$(normalize "${CLAUDE_DEGRADED_ASSIST_POLICY:-claude}")"
          main_assist_policy="$(normalize "${CLAUDE_MAIN_ASSIST_POLICY:-codex}")"
          ci_execution_engine="$(normalize "${CI_EXECUTION_ENGINE:-subscription}")"
          if [[ "${ci_execution_engine}" != "subscription" && "${ci_execution_engine}" != "harness" && "${ci_execution_engine}" != "api" ]]; then
            ci_execution_engine="subscription"
          fi
          subscription_offline_policy="$(normalize "${SUBSCRIPTION_OFFLINE_POLICY:-hold}")"
          if [[ "${subscription_offline_policy}" != "hold" && "${subscription_offline_policy}" != "continuity" ]]; then
            subscription_offline_policy="hold"
          fi
          subscription_runner_label="$(echo "${SUBSCRIPTION_RUNNER_LABEL:-fugue-subscription}" | sed -E 's/^[[:space:]]+|[[:space:]]+$//g')"
          if [[ -z "${subscription_runner_label}" ]]; then
            subscription_runner_label="fugue-subscription"
          fi

          if [[ "${ci_execution_engine}" == "subscription" && "${subscription_offline_policy}" == "hold" ]]; then
            runners_json="$(gh api "repos/${repo}/actions/runners?per_page=100" 2>/dev/null || echo '{}')"
            online_count="$(echo "${runners_json}" | jq -r --arg label "${subscription_runner_label}" '[.runners[]? | select(.status=="online" and .busy != true and ([.labels[]?.name] | index("self-hosted") != null) and ([.labels[]?.name] | index($label) != null))] | length' 2>/dev/null || echo "0")"
            online_count="$(echo "${online_count}" | tr -cd '0-9')"
            if [[ -z "${online_count}" ]]; then
              online_count="0"
            fi
            if (( online_count == 0 )); then
              echo "Canary skipped: subscription strict hold policy active and no online self-hosted runner for label ${subscription_runner_label}."
              exit 0
            fi
          fi

          eval "$(
            ./scripts/lib/orchestrator-policy.sh \
              --main "claude" \
              --assist "claude" \
              --default-main "codex" \
              --default-assist "claude" \
              --claude-state "${claude_state}" \
              --force-claude "false" \
              --assist-policy "${main_assist_policy}" \
              --claude-role-policy "${role_policy}" \
              --degraded-assist-policy "${degraded_assist_policy}"
          )"
          expected_regular_main="${resolved_main}"
          expected_regular_assist="${resolved_assist}"

          eval "$(
            ./scripts/lib/orchestrator-policy.sh \
              --main "claude" \
              --assist "claude" \
              --default-main "codex" \
              --default-assist "claude" \
              --claude-state "${claude_state}" \
              --force-claude "true" \
              --assist-policy "${main_assist_policy}" \
              --claude-role-policy "${role_policy}" \
              --degraded-assist-policy "${degraded_assist_policy}"
          )"
          expected_force_main="${resolved_main}"
          expected_force_assist="${resolved_assist}"

          gh label create "orchestrator:claude" --repo "${repo}" --description "Requested orchestrator profile for Tutti routing" --color "5319E7" >/dev/null 2>&1 || true
          gh label create "orchestrator-assist:claude" --repo "${repo}" --description "Requested assist orchestrator profile for Tutti routing" --color "0052CC" >/dev/null 2>&1 || true
          gh label create "orchestrator-force:claude" --repo "${repo}" --description "Force claude orchestrator for this issue (override rate-limit fallback)" --color "B60205" >/dev/null 2>&1 || true
          gh label create "completed" --repo "${repo}" --description "Processing completed" --color "0E8A16" >/dev/null 2>&1 || true
          gh label create "needs-human" --repo "${repo}" --description "Human intervention required" --color "D93F0B" >/dev/null 2>&1 || true

          create_issue() {
            local title="$1"
            local force_label="$2"
            local body
            body="$(printf '## Canary\nAutomated orchestration canary.\n\n- profile: codex main + claude assist default\n- case: %s\n- created_at_utc: %s\n- cleanup: auto-close on pass, keep open on failure\n' \
              "${title}" \
              "$(date -u +"%Y-%m-%dT%H:%M:%SZ")")"

            local cmd=(gh issue create --repo "${repo}" --title "${title}" --body "${body}" \
              --label "fugue-task" \
              --label "orchestrator:claude" \
              --label "orchestrator-assist:claude")
            if [[ -n "${force_label}" ]]; then
              cmd+=(--label "${force_label}")
            fi
            local url
            url="$("${cmd[@]}")"
            local issue_num="${url##*/}"
            gh issue edit "${issue_num}" --repo "${repo}" --add-label "tutti" >/dev/null
            gh workflow run fugue-tutti-caller.yml \
              --repo "${repo}" \
              -f issue_number="${issue_num}" >/dev/null
            echo "${issue_num}"
          }

          wait_for_resolved_orchestrators() {
            local issue_num="$1"
            local max_attempts=45
            local sleep_sec=20
            local attempt=1
            while [[ "${attempt}" -le "${max_attempts}" ]]; do
              comment="$(gh issue view "${issue_num}" --repo "${repo}" --json comments --jq '[.comments[].body | select(contains("## Tutti Integrated Review"))] | last // ""')"
              if [[ -n "${comment}" ]]; then
                resolved_main="$(printf '%s\n' "${comment}" | sed -n 's/^- main orchestrator resolved: //p' | head -n1 | tr -d '\r' | tr '[:upper:]' '[:lower:]')"
                resolved_assist="$(printf '%s\n' "${comment}" | sed -n 's/^- assist orchestrator resolved: //p' | head -n1 | tr -d '\r' | tr '[:upper:]' '[:lower:]')"
                if [[ -n "${resolved_main}" && -n "${resolved_assist}" ]]; then
                  echo "${resolved_main}|${resolved_assist}"
                  return 0
                fi
              fi
              sleep "${sleep_sec}"
              attempt="$((attempt + 1))"
            done
            return 1
          }

          conclude_issue() {
            local issue_num="$1"
            local expected_main="$2"
            local expected_assist="$3"
            local actual_main="$4"
            local actual_assist="$5"
            local pass="$6"
            local case_name="$7"
            if [[ "${pass}" == "true" ]]; then
              gh issue comment "${issue_num}" --repo "${repo}" --body "Canary pass (${case_name}): expected main=\`${expected_main}\` assist=\`${expected_assist}\`, actual main=\`${actual_main}\` assist=\`${actual_assist}\`."
              gh issue edit "${issue_num}" --repo "${repo}" --add-label "completed" >/dev/null
              gh issue close "${issue_num}" --repo "${repo}" --comment "Canary cleanup: closed automatically after successful verification."
            else
              gh issue comment "${issue_num}" --repo "${repo}" --body "Canary fail (${case_name}): expected main=\`${expected_main}\` assist=\`${expected_assist}\`, actual main=\`${actual_main:-timeout}\` assist=\`${actual_assist:-timeout}\`. Investigate router/caller policy."
              gh issue edit "${issue_num}" --repo "${repo}" --add-label "needs-human" >/dev/null
            fi
          }

          regular_issue="$(create_issue "[canary] regular claude request ${ts}" "")"
          force_issue="$(create_issue "[canary] forced claude request ${ts}" "orchestrator-force:claude")"

          regular_pair=""
          if regular_pair="$(wait_for_resolved_orchestrators "${regular_issue}")"; then
            regular_main="${regular_pair%%|*}"
            regular_assist="${regular_pair#*|}"
            if [[ "${regular_main}" == "${expected_regular_main}" && "${regular_assist}" == "${expected_regular_assist}" ]]; then
              conclude_issue "${regular_issue}" "${expected_regular_main}" "${expected_regular_assist}" "${regular_main}" "${regular_assist}" "true" "regular"
            else
              conclude_issue "${regular_issue}" "${expected_regular_main}" "${expected_regular_assist}" "${regular_main}" "${regular_assist}" "false" "regular"
              failures="$((failures + 1))"
            fi
          else
            conclude_issue "${regular_issue}" "${expected_regular_main}" "${expected_regular_assist}" "" "" "false" "regular"
            failures="$((failures + 1))"
          fi

          force_pair=""
          if force_pair="$(wait_for_resolved_orchestrators "${force_issue}")"; then
            force_main="${force_pair%%|*}"
            force_assist="${force_pair#*|}"
            if [[ "${force_main}" == "${expected_force_main}" && "${force_assist}" == "${expected_force_assist}" ]]; then
              conclude_issue "${force_issue}" "${expected_force_main}" "${expected_force_assist}" "${force_main}" "${force_assist}" "true" "force"
            else
              conclude_issue "${force_issue}" "${expected_force_main}" "${expected_force_assist}" "${force_main}" "${force_assist}" "false" "force"
              failures="$((failures + 1))"
            fi
          else
            conclude_issue "${force_issue}" "${expected_force_main}" "${expected_force_assist}" "" "" "false" "force"
            failures="$((failures + 1))"
          fi

          if [[ "${failures}" -gt 0 ]]; then
            echo "Canary failed: ${failures} case(s)"
            exit 1
          fi

          echo "Canary passed: regular(main=${expected_regular_main},assist=${expected_regular_assist}), force(main=${expected_force_main},assist=${expected_force_assist})"

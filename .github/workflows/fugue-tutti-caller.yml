name: Fugue Mainframe (Tutti + Optional Codex Implement)

on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number to process (used for automated handoff)"
        required: true
        type: string

permissions:
  issues: write
  contents: write
  pull-requests: write
  actions: read

concurrency:
  group: fugue-mainframe-${{ github.repository }}-${{ github.event.issue.number || github.event.inputs.issue_number || github.run_id }}
  cancel-in-progress: false

jobs:
  ctx:
    # For issues:labeled, only run when the label event is `tutti`.
    # For workflow_dispatch, treat the dispatch itself as the trigger.
    if: ${{ github.event_name != 'issues' || github.event.label.name == 'tutti' }}
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      should_run: ${{ steps.ctx.outputs.should_run }}
      skip_reason: ${{ steps.ctx.outputs.skip_reason }}
      issue_number: ${{ steps.ctx.outputs.issue_number }}
      has_implement_request: ${{ steps.ctx.outputs.has_implement_request }}
      target_repo: ${{ steps.ctx.outputs.target_repo }}
      orchestrator_provider: ${{ steps.ctx.outputs.main_orchestrator_provider }}
      main_orchestrator_provider: ${{ steps.ctx.outputs.main_orchestrator_provider }}
      assist_orchestrator_provider: ${{ steps.ctx.outputs.assist_orchestrator_provider }}
      claude_fallback_applied: ${{ steps.ctx.outputs.main_claude_fallback_applied }}
      claude_fallback_reason: ${{ steps.ctx.outputs.main_claude_fallback_reason }}
      main_claude_fallback_applied: ${{ steps.ctx.outputs.main_claude_fallback_applied }}
      main_claude_fallback_reason: ${{ steps.ctx.outputs.main_claude_fallback_reason }}
      assist_claude_fallback_applied: ${{ steps.ctx.outputs.assist_claude_fallback_applied }}
      assist_claude_fallback_reason: ${{ steps.ctx.outputs.assist_claude_fallback_reason }}
      claude_pressure_guard_applied: ${{ steps.ctx.outputs.claude_pressure_guard_applied }}
      claude_pressure_guard_reason: ${{ steps.ctx.outputs.claude_pressure_guard_reason }}
      implementation_dialogue_rounds: ${{ steps.ctx.outputs.implementation_dialogue_rounds }}
      force_claude: ${{ steps.ctx.outputs.force_claude }}
    steps:
      - name: Resolve issue context
        id: ctx
        env:
          GH_TOKEN: ${{ github.token }}
          DEFAULT_MAIN_ORCHESTRATOR_PROVIDER: ${{ vars.FUGUE_MAIN_ORCHESTRATOR_PROVIDER || vars.FUGUE_ORCHESTRATOR_PROVIDER || 'codex' }}
          DEFAULT_ASSIST_ORCHESTRATOR_PROVIDER: ${{ vars.FUGUE_ASSIST_ORCHESTRATOR_PROVIDER || 'claude' }}
          CLAUDE_RATE_LIMIT_STATE: ${{ vars.FUGUE_CLAUDE_RATE_LIMIT_STATE || 'ok' }}
          CLAUDE_MAIN_ASSIST_POLICY: ${{ vars.FUGUE_CLAUDE_MAIN_ASSIST_POLICY || 'codex' }}
          IMPLEMENT_DIALOGUE_ROUNDS_DEFAULT: ${{ vars.FUGUE_IMPLEMENT_DIALOGUE_ROUNDS || '2' }}
          IMPLEMENT_DIALOGUE_ROUNDS_CLAUDE: ${{ vars.FUGUE_IMPLEMENT_DIALOGUE_ROUNDS_CLAUDE || '1' }}
        run: |
          set -euo pipefail

          ISSUE_NUMBER=""
          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            ISSUE_NUMBER="${{ github.event.inputs.issue_number }}"
          else
            ISSUE_NUMBER="${{ github.event.issue.number }}"
          fi

          issue_json="$(gh api "repos/${GITHUB_REPOSITORY}/issues/${ISSUE_NUMBER}")"
          body="$(echo "${issue_json}" | jq -r '.body // ""')"
          owner="${GITHUB_REPOSITORY%%/*}"

          has_fugue="$(echo "${issue_json}" | jq -r '[.labels[]? | .name] | index("fugue-task") != null')"
          has_tutti="$(echo "${issue_json}" | jq -r '[.labels[]? | .name] | index("tutti") != null')"
          has_implement="$(echo "${issue_json}" | jq -r '[.labels[]? | .name] | (index("implement") != null) or (index("codex-implement") != null) or (index("claude-implement") != null)')"
          body_mode="$(printf '%s\n' "${body}" | awk '
            BEGIN { in_sec=0 }
            tolower($0) ~ /^##[[:space:]]*mode[[:space:]]*$/ { in_sec=1; next }
            in_sec && $0 ~ /^##[[:space:]]/ { exit }
            in_sec {
              line=$0
              gsub(/`/, "", line)
              gsub(/^[[:space:]]+|[[:space:]]+$/, "", line)
              if (line != "") {
                print tolower(line)
                exit
              }
            }
          ')"
          if [[ "${body_mode}" != "implement" && "${body_mode}" != "review" ]]; then
            body_mode="$(echo "${body}" | sed -nE 's/^[[:space:]]*mode[[:space:]]*:[[:space:]]*(implement|review)[[:space:]]*$/\1/ip' | head -n1 | tr '[:upper:]' '[:lower:]')"
          fi
          # Explicit review mode in issue body always wins over stale labels.
          if [[ "${body_mode}" == "review" ]]; then
            has_implement="false"
          fi
          label_main_provider="$(echo "${issue_json}" | jq -r '
            [ .labels[]? | .name ] as $labels
            | if ((($labels | index("orchestrator:claude")) != null) and (($labels | index("orchestrator:codex")) != null)) then ""
              elif (($labels | index("orchestrator:claude")) != null) then "claude"
              elif (($labels | index("orchestrator:codex")) != null) then "codex"
              else "" end
          ')"
          label_assist_provider="$(echo "${issue_json}" | jq -r '
            [ .labels[]? | .name ] as $labels
            | if (($labels | index("orchestrator-assist:none")) != null) then "none"
              elif ((($labels | index("orchestrator-assist:claude")) != null) and (($labels | index("orchestrator-assist:codex")) != null)) then ""
              elif (($labels | index("orchestrator-assist:claude")) != null) then "claude"
              elif (($labels | index("orchestrator-assist:codex")) != null) then "codex"
              else "" end
          ')"
          force_claude="$(echo "${issue_json}" | jq -r '
            [ .labels[]? | .name ] | index("orchestrator-force:claude") != null
          ')"
          body_main_provider="$(printf '%s\n' "${body}" | awk '
            BEGIN { in_sec=0 }
            tolower($0) ~ /^##[[:space:]]*orchestrator[[:space:]]+provider[[:space:]]*$/ { in_sec=1; next }
            in_sec && $0 ~ /^##[[:space:]]/ { exit }
            in_sec {
              line=$0
              gsub(/`/, "", line)
              gsub(/^[[:space:]]+|[[:space:]]+$/, "", line)
              if (line != "") {
                print tolower(line)
                exit
              }
            }
          ')"
          if [[ "${body_main_provider}" != "claude" && "${body_main_provider}" != "codex" ]]; then
            body_main_provider=""
          fi
          if [[ -z "${body_main_provider}" ]]; then
            body_main_provider="$(echo "${body}" | sed -nE 's/^[[:space:]]*orchestrator[[:space:]_-]*provider[[:space:]]*:[[:space:]]*(claude|codex)[[:space:]]*$/\1/ip' | head -n1 | tr '[:upper:]' '[:lower:]')"
          fi

          body_assist_provider="$(printf '%s\n' "${body}" | awk '
            BEGIN { in_sec=0 }
            tolower($0) ~ /^##[[:space:]]*assist[[:space:]]+orchestrator[[:space:]]+provider[[:space:]]*$/ { in_sec=1; next }
            in_sec && $0 ~ /^##[[:space:]]/ { exit }
            in_sec {
              line=$0
              gsub(/`/, "", line)
              gsub(/^[[:space:]]+|[[:space:]]+$/, "", line)
              if (line != "") {
                print tolower(line)
                exit
              }
            }
          ')"
          if [[ "${body_assist_provider}" != "claude" && "${body_assist_provider}" != "codex" && "${body_assist_provider}" != "none" ]]; then
            body_assist_provider=""
          fi
          if [[ -z "${body_assist_provider}" ]]; then
            body_assist_provider="$(echo "${body}" | sed -nE 's/^[[:space:]]*assist[[:space:]]+orchestrator[[:space:]_-]*provider[[:space:]]*:[[:space:]]*(claude|codex|none)[[:space:]]*$/\1/ip' | head -n1 | tr '[:upper:]' '[:lower:]')"
          fi

          requested_main_provider="${label_main_provider}"
          if [[ -z "${requested_main_provider}" && -n "${body_main_provider}" ]]; then
            requested_main_provider="${body_main_provider}"
          fi
          if [[ -z "${requested_main_provider}" ]]; then
            requested_main_provider="${DEFAULT_MAIN_ORCHESTRATOR_PROVIDER:-codex}"
          fi
          requested_main_provider="$(echo "${requested_main_provider}" | tr '[:upper:]' '[:lower:]' | sed -E 's/^[[:space:]]+|[[:space:]]+$//g')"
          if [[ "${requested_main_provider}" != "claude" && "${requested_main_provider}" != "codex" ]]; then
            requested_main_provider="codex"
          fi

          requested_assist_provider="${label_assist_provider}"
          if [[ -z "${requested_assist_provider}" && -n "${body_assist_provider}" ]]; then
            requested_assist_provider="${body_assist_provider}"
          fi
          if [[ -z "${requested_assist_provider}" ]]; then
            requested_assist_provider="${DEFAULT_ASSIST_ORCHESTRATOR_PROVIDER:-claude}"
          fi
          requested_assist_provider="$(echo "${requested_assist_provider}" | tr '[:upper:]' '[:lower:]' | sed -E 's/^[[:space:]]+|[[:space:]]+$//g')"
          if [[ "${requested_assist_provider}" != "claude" && "${requested_assist_provider}" != "codex" && "${requested_assist_provider}" != "none" ]]; then
            requested_assist_provider="claude"
          fi

          claude_state="$(echo "${CLAUDE_RATE_LIMIT_STATE:-ok}" | tr '[:upper:]' '[:lower:]' | sed -E 's/^[[:space:]]+|[[:space:]]+$//g')"
          if [[ "${claude_state}" != "ok" && "${claude_state}" != "degraded" && "${claude_state}" != "exhausted" ]]; then
            claude_state="ok"
          fi

          main_claude_fallback_applied="false"
          main_claude_fallback_reason=""
          if [[ "${requested_main_provider}" == "claude" && "${claude_state}" != "ok" && "${force_claude}" != "true" ]]; then
            requested_main_provider="codex"
            main_claude_fallback_applied="true"
            main_claude_fallback_reason="claude-rate-limit-${claude_state}"
          fi

          assist_claude_fallback_applied="false"
          assist_claude_fallback_reason=""
          if [[ "${requested_assist_provider}" == "claude" && "${claude_state}" == "exhausted" && "${force_claude}" != "true" ]]; then
            requested_assist_provider="none"
            assist_claude_fallback_applied="true"
            assist_claude_fallback_reason="claude-rate-limit-${claude_state}"
          fi

          claude_main_assist_policy="$(echo "${CLAUDE_MAIN_ASSIST_POLICY:-codex}" | tr '[:upper:]' '[:lower:]' | sed -E 's/^[[:space:]]+|[[:space:]]+$//g')"
          if [[ "${claude_main_assist_policy}" != "codex" && "${claude_main_assist_policy}" != "none" ]]; then
            claude_main_assist_policy="codex"
          fi
          claude_pressure_guard_applied="false"
          claude_pressure_guard_reason=""
          if [[ "${requested_main_provider}" == "claude" && "${requested_assist_provider}" == "claude" && "${force_claude}" != "true" ]]; then
            requested_assist_provider="${claude_main_assist_policy}"
            claude_pressure_guard_applied="true"
            claude_pressure_guard_reason="main-claude-assist-claude->${requested_assist_provider}"
          fi

          implementation_dialogue_rounds_raw="${IMPLEMENT_DIALOGUE_ROUNDS_DEFAULT:-2}"
          if [[ "${requested_main_provider}" == "claude" ]]; then
            implementation_dialogue_rounds_raw="${IMPLEMENT_DIALOGUE_ROUNDS_CLAUDE:-1}"
          fi
          implementation_dialogue_rounds="$(echo "${implementation_dialogue_rounds_raw}" | tr -cd '0-9')"
          if [[ -z "${implementation_dialogue_rounds}" ]]; then
            implementation_dialogue_rounds="2"
          fi
          if (( implementation_dialogue_rounds < 1 )); then
            implementation_dialogue_rounds=1
          elif (( implementation_dialogue_rounds > 5 )); then
            implementation_dialogue_rounds=5
          fi

          # 1) Prefer fully-qualified owner/repo found inside backticks.
          target_repo="$(printf '%s\n' "${body}" \
            | sed -nE 's/.*`([A-Za-z0-9_.-]+\/[A-Za-z0-9_.-]+)`.*/\1/p' \
            | head -n1)"

          # 1b) Also accept plain "owner/repo" (common on mobile forms).
          if [[ -z "${target_repo}" ]]; then
            target_repo="$(printf '%s\n' "${body}" | grep -oE "${owner}/[A-Za-z0-9_.-]+" | head -n1 || true)"
          fi

          # 2) Fallback: repo name in backticks on lines mentioning repo/リポジトリ.
          if [[ -z "${target_repo}" ]]; then
            bare_repo="$(printf '%s\n' "${body}" \
              | grep -E 'repo|Repo|repository|Repository|リポジトリ' \
              | sed -nE 's/.*`([A-Za-z0-9_.-]+)`.*/\1/p' \
              | head -n1 || true)"
            if [[ -n "${bare_repo}" ]]; then
              target_repo="${owner}/${bare_repo}"
            fi
          fi

          # 3) Default to caller repo when no hint exists.
          if [[ -z "${target_repo}" ]]; then
            target_repo="${GITHUB_REPOSITORY}"
          fi

          should_run="true"
          skip_reason=""
          if [[ "${has_fugue}" != "true" || "${has_tutti}" != "true" ]]; then
            should_run="false"
            skip_reason="missing-required-labels"
          fi

          {
            echo "issue_number=${ISSUE_NUMBER}"
            echo "has_implement_request=${has_implement}"
            echo "target_repo=${target_repo}"
            echo "orchestrator_provider=${requested_main_provider}"
            echo "main_orchestrator_provider=${requested_main_provider}"
            echo "assist_orchestrator_provider=${requested_assist_provider}"
            echo "claude_fallback_applied=${main_claude_fallback_applied}"
            echo "claude_fallback_reason=${main_claude_fallback_reason}"
            echo "main_claude_fallback_applied=${main_claude_fallback_applied}"
            echo "main_claude_fallback_reason=${main_claude_fallback_reason}"
            echo "assist_claude_fallback_applied=${assist_claude_fallback_applied}"
            echo "assist_claude_fallback_reason=${assist_claude_fallback_reason}"
            echo "claude_pressure_guard_applied=${claude_pressure_guard_applied}"
            echo "claude_pressure_guard_reason=${claude_pressure_guard_reason}"
            echo "implementation_dialogue_rounds=${implementation_dialogue_rounds}"
            echo "force_claude=${force_claude}"
            echo "should_run=${should_run}"
            echo "skip_reason=${skip_reason}"
          } >> "${GITHUB_OUTPUT}"

      - name: Comment fallback decision
        if: ${{ steps.ctx.outputs.should_run == 'true' && (steps.ctx.outputs.main_claude_fallback_applied == 'true' || steps.ctx.outputs.assist_claude_fallback_applied == 'true' || steps.ctx.outputs.claude_pressure_guard_applied == 'true') }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [[ "${{ steps.ctx.outputs.main_claude_fallback_applied }}" == "true" ]]; then
            gh issue edit "${{ steps.ctx.outputs.issue_number }}" \
              --repo "${GITHUB_REPOSITORY}" \
              --remove-label "orchestrator:claude" \
              --add-label "orchestrator:codex" >/dev/null 2>&1 || true
          fi
          if [[ "${{ steps.ctx.outputs.assist_claude_fallback_applied }}" == "true" ]]; then
            gh issue edit "${{ steps.ctx.outputs.issue_number }}" \
              --repo "${GITHUB_REPOSITORY}" \
              --remove-label "orchestrator-assist:claude" \
              --add-label "orchestrator-assist:none" >/dev/null 2>&1 || true
          fi
          if [[ "${{ steps.ctx.outputs.claude_pressure_guard_applied }}" == "true" ]]; then
            target_assist="$(echo "${{ steps.ctx.outputs.assist_orchestrator_provider }}" | tr '[:upper:]' '[:lower:]')"
            gh issue edit "${{ steps.ctx.outputs.issue_number }}" \
              --repo "${GITHUB_REPOSITORY}" \
              --remove-label "orchestrator-assist:claude" >/dev/null 2>&1 || true
            if [[ "${target_assist}" == "codex" || "${target_assist}" == "none" ]]; then
              gh issue edit "${{ steps.ctx.outputs.issue_number }}" \
                --repo "${GITHUB_REPOSITORY}" \
                --add-label "orchestrator-assist:${target_assist}" >/dev/null 2>&1 || true
            fi
          fi
          gh issue comment "${{ steps.ctx.outputs.issue_number }}" \
            --repo "${GITHUB_REPOSITORY}" \
            --body "Orchestrator auto-adjust applied. Main fallback: \`${{ steps.ctx.outputs.main_claude_fallback_applied }}\` (\`${{ steps.ctx.outputs.main_claude_fallback_reason }}\`). Assist fallback: \`${{ steps.ctx.outputs.assist_claude_fallback_applied }}\` (\`${{ steps.ctx.outputs.assist_claude_fallback_reason }}\`). Claude pressure guard: \`${{ steps.ctx.outputs.claude_pressure_guard_applied }}\` (\`${{ steps.ctx.outputs.claude_pressure_guard_reason }}\`). To force Claude for this issue, add label \`orchestrator-force:claude\`."

  # Review mode: Tutti consensus (6+ parallel lanes baseline)
  tutti:
    if: >-
      needs.ctx.outputs.should_run == 'true'
    needs: [ctx]
    uses: ./.github/workflows/fugue-tutti-router.yml
    with:
      issue_number: "${{ needs.ctx.outputs.issue_number }}"
      orchestrator_provider: "${{ needs.ctx.outputs.orchestrator_provider }}"
      main_orchestrator_provider: "${{ needs.ctx.outputs.main_orchestrator_provider }}"
      assist_orchestrator_provider: "${{ needs.ctx.outputs.assist_orchestrator_provider }}"
      force_claude: "${{ needs.ctx.outputs.force_claude }}"
    secrets:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      ZAI_API_KEY: ${{ secrets.ZAI_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

  # Implement mode: if Tutti says it's safe AND issue requests implementation, run Codex implement immediately.
  codex-implement:
    if: >-
      needs.ctx.outputs.should_run == 'true' &&
      needs.ctx.outputs.has_implement_request == 'true' &&
      needs.tutti.outputs.ok_to_execute == 'true'
    needs: [ctx, tutti]
    uses: ./.github/workflows/fugue-codex-implement.yml
    with:
      issue_number: "${{ needs.ctx.outputs.issue_number }}"
      target_repo: "${{ needs.ctx.outputs.target_repo }}"
      refinement_cycles: "${{ vars.FUGUE_IMPLEMENT_REFINEMENT_CYCLES || '3' }}"
      implementation_dialogue_rounds: "${{ needs.ctx.outputs.implementation_dialogue_rounds }}"
    secrets:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      TARGET_REPO_PAT: ${{ secrets.TARGET_REPO_PAT }}

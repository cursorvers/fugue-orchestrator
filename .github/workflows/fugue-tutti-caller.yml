name: Fugue Mainframe (Tutti + Optional Codex Implement)

on:
  issues:
    types: [labeled]

permissions:
  issues: write
  contents: write
  pull-requests: write
  actions: read

jobs:
  resolve-target:
    if: >-
      github.actor != 'github-actions[bot]' &&
      github.event.label.name == 'tutti' &&
      contains(github.event.issue.labels.*.name, 'fugue-task') &&
      contains(github.event.issue.labels.*.name, 'codex-implement')
    runs-on: ubuntu-latest
    outputs:
      target_repo: ${{ steps.resolve.outputs.target_repo }}
    steps:
      - name: Resolve target repository from issue body
        id: resolve
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          issue_number="${{ github.event.issue.number }}"
          issue_json="$(gh api "repos/${GITHUB_REPOSITORY}/issues/${issue_number}")"
          body="$(echo "${issue_json}" | jq -r '.body // ""')"
          owner="${GITHUB_REPOSITORY%%/*}"

          # 1) Prefer fully-qualified owner/repo found inside backticks.
          target_repo="$(printf '%s\n' "${body}" \
            | sed -nE 's/.*`([A-Za-z0-9_.-]+\/[A-Za-z0-9_.-]+)`.*/\1/p' \
            | head -n1)"

          # 2) Fallback: repo name in backticks on lines mentioning repo/リポジトリ.
          if [[ -z "${target_repo}" ]]; then
            bare_repo="$(printf '%s\n' "${body}" \
              | grep -E 'repo|Repo|repository|Repository|リポジトリ' \
              | sed -nE 's/.*`([A-Za-z0-9_.-]+)`.*/\1/p' \
              | head -n1 || true)"
            if [[ -n "${bare_repo}" ]]; then
              target_repo="${owner}/${bare_repo}"
            fi
          fi

          # 3) Default to caller repo when no hint exists.
          if [[ -z "${target_repo}" ]]; then
            target_repo="${GITHUB_REPOSITORY}"
          fi

          echo "target_repo=${target_repo}" >> "${GITHUB_OUTPUT}"

  # Review mode: Tutti consensus (currently 3 parallel agents)
  tutti:
    if: >-
      github.actor != 'github-actions[bot]' &&
      github.event.label.name == 'tutti' &&
      contains(github.event.issue.labels.*.name, 'fugue-task') &&
      contains(github.event.issue.labels.*.name, 'tutti')
    uses: ./.github/workflows/fugue-tutti-router.yml
    with:
      issue_number: "${{ format('{0}', github.event.issue.number) }}"
    secrets:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      ZAI_API_KEY: ${{ secrets.ZAI_API_KEY }}

  # Implement mode: if Tutti says it's safe AND issue requests implementation, run Codex implement immediately.
  codex-implement:
    if: >-
      github.actor != 'github-actions[bot]' &&
      github.event.label.name == 'tutti' &&
      contains(github.event.issue.labels.*.name, 'fugue-task') &&
      contains(github.event.issue.labels.*.name, 'codex-implement') &&
      needs.tutti.outputs.ok_to_execute == 'true'
    needs: [resolve-target, tutti]
    uses: ./.github/workflows/fugue-codex-implement.yml
    with:
      issue_number: "${{ format('{0}', github.event.issue.number) }}"
      target_repo: "${{ needs.resolve-target.outputs.target_repo }}"
    secrets:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      TARGET_REPO_PAT: ${{ secrets.TARGET_REPO_PAT }}

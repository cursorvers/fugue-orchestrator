name: fugue-codex-implement

on:
  workflow_call:
    inputs:
      issue_number:
        description: "Issue number containing implementation instructions"
        required: true
        type: string
      target_repo:
        description: "Target repository (owner/repo) for code generation. Defaults to caller repo."
        required: false
        type: string
        default: ""
      target_branch:
        description: "Base branch to create PR against"
        required: false
        type: string
        default: "main"
      codex_model:
        description: "Codex model to use"
        required: false
        type: string
        default: "gpt-5.1-codex-mini"
      refinement_cycles:
        description: "Pre-implementation refinement cycles (Plan/Parallel Simulation/Critical Review/Fix/Replan)"
        required: false
        type: string
        default: "3"
      implementation_dialogue_rounds:
        description: "Implementation-phase collaboration rounds (Implementer/Critic/Integrator)"
        required: false
        type: string
        default: "2"
      orchestration_profile:
        description: "Resolved orchestration profile (codex-full|claude-light)"
        required: false
        type: string
        default: "codex-full"
      risk_tier:
        description: "Resolved risk tier (low|medium|high)"
        required: false
        type: string
        default: ""
      lessons_required:
        description: "Whether lessons update is strictly required (true|false|auto)"
        required: false
        type: string
        default: "auto"
      correction_signal:
        description: "Whether this issue includes explicit correction/postmortem signal (true|false|auto)"
        required: false
        type: string
        default: "auto"
    secrets:
      OPENAI_API_KEY:
        required: true
      TARGET_REPO_PAT:
        required: false

permissions:
  issues: write
  contents: write
  pull-requests: write

concurrency:
  group: fugue-codex-impl-${{ github.repository }}-${{ inputs.issue_number }}
  cancel-in-progress: false

jobs:
  prepare:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      should_run: ${{ steps.ctx.outputs.should_run }}
      skip_reason: ${{ steps.ctx.outputs.skip_reason }}
      issue_number: ${{ steps.ctx.outputs.issue_number }}
      issue_title: ${{ steps.ctx.outputs.issue_title }}
      issue_body: ${{ steps.ctx.outputs.issue_body }}
      is_large_refactor: ${{ steps.ctx.outputs.is_large_refactor }}
      target_repo: ${{ steps.ctx.outputs.target_repo }}
      branch_name: ${{ steps.ctx.outputs.branch_name }}
      risk_tier: ${{ steps.ctx.outputs.risk_tier }}
      risk_score: ${{ steps.ctx.outputs.risk_score }}
      risk_reasons: ${{ steps.ctx.outputs.risk_reasons }}
      lessons_required: ${{ steps.ctx.outputs.lessons_required }}
      correction_signal: ${{ steps.ctx.outputs.correction_signal }}
      preflight_cycles_floor: ${{ steps.ctx.outputs.preflight_cycles_floor }}
      implementation_dialogue_rounds_floor: ${{ steps.ctx.outputs.implementation_dialogue_rounds_floor }}
      context_budget_initial: ${{ steps.ctx.outputs.context_budget_initial }}
      context_budget_max: ${{ steps.ctx.outputs.context_budget_max }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Resolve issue context
        id: ctx
        env:
          GH_TOKEN: ${{ github.token }}
          ORCHESTRATION_PROFILE: ${{ inputs.orchestration_profile }}
          INPUT_RISK_TIER: ${{ inputs.risk_tier }}
          INPUT_LESSONS_REQUIRED: ${{ inputs.lessons_required }}
          INPUT_CORRECTION_SIGNAL: ${{ inputs.correction_signal }}
        run: |
          set -euo pipefail

          ISSUE_NUMBER="${{ inputs.issue_number }}"
          issue_json="$(gh api "repos/${GITHUB_REPOSITORY}/issues/${ISSUE_NUMBER}")"

          TITLE="$(echo "${issue_json}" | jq -r '.title // ""')"
          BODY="$(echo "${issue_json}" | jq -r '.body // ""')"
          AUTHOR="$(echo "${issue_json}" | jq -r '.user.login // ""')"
          HAS_IMPLEMENT="$(echo "${issue_json}" | jq -r '[.labels[].name] | (index("implement") != null) or (index("codex-implement") != null) or (index("claude-implement") != null)')"
          HAS_IMPLEMENT_CONFIRMED="$(echo "${issue_json}" | jq -r '[.labels[].name] | (index("implement-confirmed") != null)')"
          HAS_LARGE_REFACTOR="$(echo "${issue_json}" | jq -r '[.labels[].name] | (index("large-refactor") != null)')"
          LABELS_CSV="$(echo "${issue_json}" | jq -r '[.labels[]?.name] | join(",")')"

          SHOULD_RUN="true"
          SKIP_REASON=""
          if [[ "${HAS_IMPLEMENT}" != "true" ]]; then
            SHOULD_RUN="false"
            SKIP_REASON="missing-implement-intent"
          elif [[ "${HAS_IMPLEMENT_CONFIRMED}" != "true" ]]; then
            SHOULD_RUN="false"
            SKIP_REASON="missing-implement-confirmed"
          fi

          # Determine target repo
          TARGET_REPO="${{ inputs.target_repo }}"
          if [[ -z "${TARGET_REPO}" ]]; then
            TARGET_REPO="${GITHUB_REPOSITORY}"
          fi

          # Generate branch name from issue number
          SAFE_TITLE="$(echo "${TITLE}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | head -c 40)"
          BRANCH_NAME="codex/issue-${ISSUE_NUMBER}-${SAFE_TITLE}"

          eval "$(
            scripts/lib/workflow-risk-policy.sh \
              --title "${TITLE}" \
              --body "${BODY}" \
              --labels "${LABELS_CSV}" \
              --has-implement "${HAS_IMPLEMENT}" \
              --orchestration-profile "${ORCHESTRATION_PROFILE}"
          )"
          if [[ "${INPUT_RISK_TIER}" == "low" || "${INPUT_RISK_TIER}" == "medium" || "${INPUT_RISK_TIER}" == "high" ]]; then
            risk_tier="${INPUT_RISK_TIER}"
          fi
          input_correction_signal="$(echo "${INPUT_CORRECTION_SIGNAL:-auto}" | tr '[:upper:]' '[:lower:]')"
          if [[ "${input_correction_signal}" == "true" || "${input_correction_signal}" == "false" ]]; then
            correction_signal="${input_correction_signal}"
          fi
          input_lessons_required="$(echo "${INPUT_LESSONS_REQUIRED:-auto}" | tr '[:upper:]' '[:lower:]')"
          if [[ "${input_lessons_required}" == "true" || "${input_lessons_required}" == "false" ]]; then
            lessons_required="${input_lessons_required}"
          fi
          if [[ "${correction_signal}" == "true" ]]; then
            lessons_required="true"
          fi

          {
            echo "issue_number=${ISSUE_NUMBER}"
            echo "issue_title<<EOF"
            echo "${TITLE}"
            echo "EOF"
            echo "issue_body<<EOF"
            echo "${BODY}"
            echo "EOF"
            echo "is_large_refactor=${HAS_LARGE_REFACTOR}"
            echo "should_run=${SHOULD_RUN}"
            echo "skip_reason=${SKIP_REASON}"
            echo "target_repo=${TARGET_REPO}"
            echo "branch_name=${BRANCH_NAME}"
            echo "risk_tier=${risk_tier}"
            echo "risk_score=${risk_score}"
            echo "risk_reasons=${risk_reasons}"
            echo "lessons_required=${lessons_required}"
            echo "correction_signal=${correction_signal}"
            echo "preflight_cycles_floor=${preflight_cycles_floor}"
            echo "implementation_dialogue_rounds_floor=${implementation_dialogue_rounds_floor}"
            echo "context_budget_initial=${context_budget_initial}"
            echo "context_budget_max=${context_budget_max}"
          } >> "${GITHUB_OUTPUT}"

      - name: Notify pending implement confirmation
        if: ${{ steps.ctx.outputs.should_run != 'true' && steps.ctx.outputs.skip_reason == 'missing-implement-confirmed' }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue comment "${{ steps.ctx.outputs.issue_number }}" --repo "${GITHUB_REPOSITORY}" --body "Implementation intent detected, but \`implement-confirmed\` is missing. Add that label to allow Codex execution."

      - name: Add processing label
        if: ${{ steps.ctx.outputs.should_run == 'true' }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue edit "${{ steps.ctx.outputs.issue_number }}" \
            --repo "${GITHUB_REPOSITORY}" \
            --remove-label "completed" --remove-label "needs-review" || true
          gh issue edit "${{ steps.ctx.outputs.issue_number }}" \
            --repo "${GITHUB_REPOSITORY}" \
            --add-label "processing"

  implement:
    if: ${{ needs.prepare.outputs.should_run == 'true' }}
    needs: [prepare]
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
    outputs:
      pr_url: ${{ steps.create-pr.outputs.pr_url }}
      codex_exit: ${{ steps.codex.outputs.exit_code }}
      preflight_report_path: ${{ steps.codex.outputs.preflight_report_path }}
      implementation_report_path: ${{ steps.codex.outputs.implementation_report_path }}
      todo_report_path: ${{ steps.codex.outputs.todo_report_path }}
      lessons_report_path: ${{ steps.codex.outputs.lessons_report_path }}

    steps:
      - name: Guard PAT for cross-repo operations
        if: ${{ needs.prepare.outputs.target_repo != github.repository }}
        env:
          GH_TOKEN: ${{ github.token }}
          TARGET_REPO_PAT: ${{ secrets.TARGET_REPO_PAT }}
          ISSUE_NUMBER: ${{ needs.prepare.outputs.issue_number }}
          TARGET_REPO: ${{ needs.prepare.outputs.target_repo }}
        run: |
          set -euo pipefail
          if [[ -z "${TARGET_REPO_PAT}" ]]; then
            gh issue comment "${ISSUE_NUMBER}" --repo "${GITHUB_REPOSITORY}" --body "Cannot implement into ${TARGET_REPO}: missing secret TARGET_REPO_PAT. Escalating to humans."
            gh issue edit "${ISSUE_NUMBER}" --repo "${GITHUB_REPOSITORY}" --add-label "needs-human" --remove-label "processing" || true
            exit 0
          fi

      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ needs.prepare.outputs.target_repo }}
          token: ${{ secrets.TARGET_REPO_PAT || github.token }}
          ref: ${{ inputs.target_branch }}
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install Codex CLI
        run: |
          npm install -g @openai/codex
          codex --version

      - name: Authenticate Codex CLI with API key
        run: |
          printenv OPENAI_API_KEY | codex login --with-api-key

      - name: Create working branch
        run: |
          git checkout -b "${{ needs.prepare.outputs.branch_name }}"

      - name: Run Codex CLI
        id: codex
        env:
          ISSUE_TITLE: ${{ needs.prepare.outputs.issue_title }}
          ISSUE_BODY: ${{ needs.prepare.outputs.issue_body }}
          CODEX_MODEL: ${{ inputs.codex_model }}
          REFINEMENT_CYCLES: ${{ inputs.refinement_cycles }}
          IMPLEMENTATION_DIALOGUE_ROUNDS: ${{ inputs.implementation_dialogue_rounds }}
          ORCHESTRATION_PROFILE: ${{ inputs.orchestration_profile }}
          ISSUE_NUMBER: ${{ needs.prepare.outputs.issue_number }}
          LARGE_REFACTOR_LABEL: ${{ needs.prepare.outputs.is_large_refactor }}
          RISK_TIER: ${{ needs.prepare.outputs.risk_tier }}
          RISK_SCORE: ${{ needs.prepare.outputs.risk_score }}
          RISK_REASONS: ${{ needs.prepare.outputs.risk_reasons }}
          LESSONS_REQUIRED: ${{ needs.prepare.outputs.lessons_required }}
          CORRECTION_SIGNAL: ${{ needs.prepare.outputs.correction_signal }}
          PREFLIGHT_CYCLES_FLOOR: ${{ needs.prepare.outputs.preflight_cycles_floor }}
          IMPLEMENTATION_DIALOGUE_ROUNDS_FLOOR: ${{ needs.prepare.outputs.implementation_dialogue_rounds_floor }}
          CONTEXT_BUDGET_INITIAL: ${{ needs.prepare.outputs.context_budget_initial }}
          CONTEXT_BUDGET_MAX: ${{ needs.prepare.outputs.context_budget_max }}
        run: |
          set -euo pipefail

          orchestration_profile="$(echo "${ORCHESTRATION_PROFILE:-codex-full}" | tr '[:upper:]' '[:lower:]' | sed -E 's/^[[:space:]]+|[[:space:]]+$//g')"
          if [[ "${orchestration_profile}" != "codex-full" && "${orchestration_profile}" != "claude-light" ]]; then
            orchestration_profile="codex-full"
          fi
          cycles_raw="$(echo "${REFINEMENT_CYCLES:-3}" | tr -cd '0-9')"
          if [[ -z "${cycles_raw}" ]]; then
            cycles_raw="3"
          fi
          if [[ "${orchestration_profile}" == "claude-light" ]]; then
            if (( cycles_raw < 1 )); then
              cycles_raw=1
            elif (( cycles_raw > 3 )); then
              cycles_raw=3
            fi
          else
            if (( cycles_raw < 3 )); then
              cycles_raw=3
            elif (( cycles_raw > 5 )); then
              cycles_raw=5
            fi
          fi
          preflight_floor="$(echo "${PREFLIGHT_CYCLES_FLOOR:-1}" | tr -cd '0-9')"
          if [[ -z "${preflight_floor}" ]]; then
            preflight_floor="1"
          fi
          if (( cycles_raw < preflight_floor )); then
            cycles_raw="${preflight_floor}"
          fi
          cycles="${cycles_raw}"
          dialogue_rounds_raw="$(echo "${IMPLEMENTATION_DIALOGUE_ROUNDS:-2}" | tr -cd '0-9')"
          if [[ -z "${dialogue_rounds_raw}" ]]; then
            dialogue_rounds_raw="2"
          fi
          if (( dialogue_rounds_raw < 1 )); then
            dialogue_rounds_raw=1
          elif (( dialogue_rounds_raw > 5 )); then
            dialogue_rounds_raw=5
          fi
          dialogue_floor="$(echo "${IMPLEMENTATION_DIALOGUE_ROUNDS_FLOOR:-1}" | tr -cd '0-9')"
          if [[ -z "${dialogue_floor}" ]]; then
            dialogue_floor="1"
          fi
          if (( dialogue_rounds_raw < dialogue_floor )); then
            dialogue_rounds_raw="${dialogue_floor}"
          fi
          dialogue_rounds="${dialogue_rounds_raw}"
          risk_tier="$(echo "${RISK_TIER:-medium}" | tr '[:upper:]' '[:lower:]')"
          if [[ "${risk_tier}" != "low" && "${risk_tier}" != "medium" && "${risk_tier}" != "high" ]]; then
            risk_tier="medium"
          fi
          lessons_required="$(echo "${LESSONS_REQUIRED:-false}" | tr '[:upper:]' '[:lower:]')"
          if [[ "${lessons_required}" != "true" ]]; then
            lessons_required="false"
          fi
          correction_signal="$(echo "${CORRECTION_SIGNAL:-false}" | tr '[:upper:]' '[:lower:]')"
          if [[ "${correction_signal}" != "true" ]]; then
            correction_signal="false"
          fi
          preflight_report=".fugue/pre-implement/issue-${ISSUE_NUMBER}-preflight.md"
          implementation_report=".fugue/implement/issue-${ISSUE_NUMBER}-implementation-loop.md"
          todo_report=".fugue/pre-implement/issue-${ISSUE_NUMBER}-todo.md"
          lessons_report=".fugue/pre-implement/lessons.md"
          title_text="$(printf '%s\n' "${ISSUE_TITLE}" | tr '[:upper:]' '[:lower:]')"
          goal_text="$(printf '%s\n' "${ISSUE_BODY}" | awk '
            BEGIN { capture=0 }
            /^###[[:space:]]*Goal[[:space:]]*$/ { capture=1; next }
            capture && /^###[[:space:]]/ { exit }
            capture && NF { print; exit }
          ' | tr '[:upper:]' '[:lower:]')"
          task_signal_text="$(printf '%s\n%s\n' "${title_text}" "${goal_text}")"
          is_large_refactor="false"
          if [[ "${LARGE_REFACTOR_LABEL:-false}" == "true" ]]; then
            is_large_refactor="true"
          elif echo "${task_signal_text}" | grep -Eqi '(大規模|全面|全体|リファクタ|refactor|migration|rewrite|アーキテクチャ刷新)'; then
            is_large_refactor="true"
          fi

          # Build instruction from issue
          INSTRUCTION="## Task: ${ISSUE_TITLE}

          ${ISSUE_BODY}

          ## Mandatory pre-implementation protocol (${orchestration_profile})
          - Before touching implementation, run this loop exactly ${cycles} times.
          - Each cycle MUST include these five steps in order:
            1. Plan
            2. Parallel Simulation
            3. Critical Review
            4. Problem Fix
            5. Replan
          - Record every cycle in ${preflight_report} using this exact section format:
            - ## Cycle N
            - ### 1. Plan
            - ### 2. Parallel Simulation
            - ### 3. Critical Review
            - ### 4. Problem Fix
            - ### 5. Replan
          - Parallel Simulation and Critical Review are mandatory gates and cannot be skipped.
          - If this is a large refactor/rewrite/migration task (detected=${is_large_refactor}), every cycle MUST include:
            - #### Candidate A
            - #### Candidate B
            - #### Failure Modes
            - #### Rollback Check
          - After all preflight cycles complete, proceed to implementation-phase collaboration.
          - If a cycle reveals a blocking issue, resolve it before moving to the next cycle.

          ## Mandatory implementation collaboration protocol
          - During implementation, run this dialogue loop exactly ${dialogue_rounds} rounds.
          - Treat this as team collaboration with distinct roles:
            - Implementer: proposes concrete code changes and file-level edits.
            - Critic: challenges regressions, security gaps, and test insufficiency.
            - Integrator: resolves disagreements and decides the merged patch direction.
          - Record all rounds in ${implementation_report} using this exact format:
            - ## Round N
            - ### Implementer Proposal
            - ### Critic Challenge
            - ### Integrator Decision
            - ### Applied Change
            - ### Verification
          - Apply only integrator-approved changes for each round.
          - Final code must reflect the latest integrator decisions.

          ## Shared task management + self-improvement protocol
          - Use this policy boundary:
            - MUST: preflight loops + implementation dialogue + verification evidence.
            - SHOULD: update lessons when correction signals/postmortem are present.
            - MAY: use extra subagent fan-out only for unresolved uncertainty.
          - Risk tier for this issue: ${risk_tier} (score=${RISK_SCORE:-0}, reasons=${RISK_REASONS:-none}).
          - Context budget guidance: initial sources <= ${CONTEXT_BUDGET_INITIAL:-6}, expand only when blocked up to ${CONTEXT_BUDGET_MAX:-12}.
          - Keep checkable execution items in ${todo_report}.
          - ${todo_report} MUST contain these headings:
            - ## Plan
            - ## Checklist
            - ## Progress
            - ## Review
          - Checklist items must be markdown checkboxes and updated during execution.
          - When correction signals or postmortem findings exist (required=${lessons_required}, correction_signal=${correction_signal}), append durable prevention rules to ${lessons_report}.
          - If lessons are required for this issue, add a section header exactly: ## Issue #${ISSUE_NUMBER}
          - Ensure ${lessons_report} exists (create a minimal header when lessons are not required in this run).
          - ${lessons_report} entries should capture:
            - Mistake pattern
            - Preventive rule
            - Trigger signal
          - Before finalizing, include concrete verification evidence (tests, logs, or behavioral diff).

          ## Rules
          - Implement the changes described above
          - Follow existing code style and patterns
          - Do NOT modify unrelated files
          - Ensure code compiles/passes lint
          - Add tests if test infrastructure exists
          - Keep all preflight reasoning concise and actionable"

          # Write instruction to temp file to avoid shell escaping issues
          echo "${INSTRUCTION}" > /tmp/codex-instruction.md

          # Run Codex non-interactively in full-auto mode.
          EXIT_CODE=0
          codex exec \
            --model "${CODEX_MODEL}" \
            --full-auto \
            "$(cat /tmp/codex-instruction.md)" \
            2>&1 | tee /tmp/codex-output.log || EXIT_CODE=$?

          echo "preflight_report_path=${preflight_report}" >> "${GITHUB_OUTPUT}"
          echo "implementation_report_path=${implementation_report}" >> "${GITHUB_OUTPUT}"
          echo "todo_report_path=${todo_report}" >> "${GITHUB_OUTPUT}"
          echo "lessons_report_path=${lessons_report}" >> "${GITHUB_OUTPUT}"

          # Enforce the default refinement protocol before implementation is accepted.
          if [[ ! -f "${preflight_report}" ]]; then
            echo "Missing mandatory preflight report: ${preflight_report}" | tee -a /tmp/codex-output.log
            EXIT_CODE=1
          else
            for i in $(seq 1 "${cycles}"); do
              if ! grep -q "^## Cycle ${i}$" "${preflight_report}"; then
                echo "Missing section: ## Cycle ${i}" | tee -a /tmp/codex-output.log
                EXIT_CODE=1
                continue
              fi
              block="$(awk -v n="${i}" '
                $0 == "## Cycle " n {on=1; next}
                on && /^## Cycle [0-9]+$/ {exit}
                on {print}
              ' "${preflight_report}")"
              for heading in \
                "### 1. Plan" \
                "### 2. Parallel Simulation" \
                "### 3. Critical Review" \
                "### 4. Problem Fix" \
                "### 5. Replan"; do
                if ! printf '%s\n' "${block}" | grep -q "^${heading}$"; then
                  echo "Cycle ${i} missing heading: ${heading}" | tee -a /tmp/codex-output.log
                  EXIT_CODE=1
                fi
              done
              if [[ "${is_large_refactor}" == "true" ]]; then
                for heading in \
                  "#### Candidate A" \
                  "#### Candidate B" \
                  "#### Failure Modes" \
                  "#### Rollback Check"; do
                  if ! printf '%s\n' "${block}" | grep -q "^${heading}$"; then
                    echo "Cycle ${i} missing large-refactor section: ${heading}" | tee -a /tmp/codex-output.log
                    EXIT_CODE=1
                  fi
                done
              fi
            done
          fi

          # Enforce implementation-phase dialogue loop report.
          if [[ ! -f "${implementation_report}" ]]; then
            echo "Missing mandatory implementation collaboration report: ${implementation_report}" | tee -a /tmp/codex-output.log
            EXIT_CODE=1
          else
            for i in $(seq 1 "${dialogue_rounds}"); do
              if ! grep -q "^## Round ${i}$" "${implementation_report}"; then
                echo "Missing section: ## Round ${i}" | tee -a /tmp/codex-output.log
                EXIT_CODE=1
                continue
              fi
              block="$(awk -v n="${i}" '
                $0 == "## Round " n {on=1; next}
                on && /^## Round [0-9]+$/ {exit}
                on {print}
              ' "${implementation_report}")"
              for heading in \
                "### Implementer Proposal" \
                "### Critic Challenge" \
                "### Integrator Decision" \
                "### Applied Change" \
                "### Verification"; do
                if ! printf '%s\n' "${block}" | grep -q "^${heading}$"; then
                  echo "Round ${i} missing heading: ${heading}" | tee -a /tmp/codex-output.log
                  EXIT_CODE=1
                fi
              done
            done
          fi

          # Enforce shared task tracking artifact.
          if [[ ! -f "${todo_report}" ]]; then
            echo "Missing mandatory task ledger: ${todo_report}" | tee -a /tmp/codex-output.log
            EXIT_CODE=1
          else
            for heading in "## Plan" "## Checklist" "## Progress" "## Review"; do
              if ! grep -q "^${heading}$" "${todo_report}"; then
                echo "Task ledger missing heading: ${heading}" | tee -a /tmp/codex-output.log
                EXIT_CODE=1
              fi
            done
            if ! grep -Eq '^[[:space:]]*-[[:space:]]\[[ xX]\][[:space:]]+' "${todo_report}"; then
              echo "Task ledger has no markdown checkbox items: ${todo_report}" | tee -a /tmp/codex-output.log
              EXIT_CODE=1
            fi
          fi

          # Lessons are strict only when correction/postmortem signals are present.
          if [[ ! -f "${lessons_report}" ]]; then
            if [[ "${lessons_required}" == "true" ]]; then
              echo "Missing required lessons artifact: ${lessons_report}" | tee -a /tmp/codex-output.log
              EXIT_CODE=1
            else
              mkdir -p "$(dirname "${lessons_report}")"
              {
                echo "# Lessons Ledger"
                echo
                echo "_Autocreated because lessons update was optional for this run._"
              } > "${lessons_report}"
            fi
          fi
          if [[ "${lessons_required}" == "true" ]]; then
            if ! grep -Eq "^##[[:space:]]+Issue[[:space:]]+#${ISSUE_NUMBER}$" "${lessons_report}"; then
              echo "Lessons required but missing issue-specific section: ## Issue #${ISSUE_NUMBER}" | tee -a /tmp/codex-output.log
              EXIT_CODE=1
            fi
          fi

          echo "exit_code=${EXIT_CODE}" >> "${GITHUB_OUTPUT}"

          # Check if any files were changed (including untracked files).
          # `git diff` does not detect newly-created (untracked) files, which can
          # cause us to incorrectly skip commit/PR creation.
          if [[ -z "$(git status --porcelain)" ]]; then
            echo "no_changes=true" >> "${GITHUB_OUTPUT}"
          else
            echo "no_changes=false" >> "${GITHUB_OUTPUT}"
          fi

      - name: Commit changes
        if: ${{ steps.codex.outputs.no_changes != 'true' && steps.codex.outputs.exit_code == '0' }}
        run: |
          git config user.name "fugue-codex[bot]"
          git config user.email "fugue-codex[bot]@users.noreply.github.com"
          git add -A
          git commit -m "feat: implement issue #${{ needs.prepare.outputs.issue_number }}

          Generated by Codex CLI (${{ inputs.codex_model }}) via FUGUE GHA24.

          Closes #${{ needs.prepare.outputs.issue_number }}"

      - name: Push branch
        if: ${{ steps.codex.outputs.no_changes != 'true' && steps.codex.outputs.exit_code == '0' }}
        env:
          GH_TOKEN: ${{ secrets.TARGET_REPO_PAT || github.token }}
        run: |
          git push origin "${{ needs.prepare.outputs.branch_name }}"

      - name: Create Pull Request
        id: create-pr
        if: ${{ steps.codex.outputs.no_changes != 'true' && steps.codex.outputs.exit_code == '0' }}
        env:
          GH_TOKEN: ${{ secrets.TARGET_REPO_PAT || github.token }}
        run: |
          set -euo pipefail

          TARGET_REPO="${{ needs.prepare.outputs.target_repo }}"
          ISSUE_NUM="${{ needs.prepare.outputs.issue_number }}"

          PR_URL="$(gh pr create \
            --repo "${TARGET_REPO}" \
            --base "${{ inputs.target_branch }}" \
            --head "${{ needs.prepare.outputs.branch_name }}" \
            --title "feat: implement #${ISSUE_NUM} (Codex)" \
            --body "## Auto-generated by FUGUE Codex Implement

          **Source issue**: #${ISSUE_NUM}
          **Model**: ${{ inputs.codex_model }}
          **Mode**: full-auto

          ### Changes
          $(git log --oneline -1)

          ### Review checklist
          - [ ] Code compiles
          - [ ] Tests pass
          - [ ] No unintended file changes
          - [ ] Security review (no secrets leaked)

          ---
          Generated by [FUGUE GHA24](https://github.com/${GITHUB_REPOSITORY})")"

          echo "pr_url=${PR_URL}" >> "${GITHUB_OUTPUT}"

      - name: Upload Codex log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: codex-output-log
          path: |
            /tmp/codex-output.log
            ${{ steps.codex.outputs.preflight_report_path }}
            ${{ steps.codex.outputs.implementation_report_path }}
            ${{ steps.codex.outputs.todo_report_path }}
            ${{ steps.codex.outputs.lessons_report_path }}
          if-no-files-found: ignore

  finalize:
    if: always() && needs.prepare.outputs.should_run == 'true'
    needs: [prepare, implement]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Update issue with results
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ needs.prepare.outputs.issue_number }}
          PR_URL: ${{ needs.implement.outputs.pr_url }}
          CODEX_EXIT: ${{ needs.implement.outputs.codex_exit }}
        run: |
          set -euo pipefail

          gh issue edit "${ISSUE_NUMBER}" --repo "${GITHUB_REPOSITORY}" \
            --remove-label "processing" || true

          if [[ -n "${PR_URL}" ]]; then
            gh issue comment "${ISSUE_NUMBER}" --repo "${GITHUB_REPOSITORY}" \
              --body "Codex implementation complete. PR created: ${PR_URL}

          Exit code: ${CODEX_EXIT}"
            gh issue edit "${ISSUE_NUMBER}" --repo "${GITHUB_REPOSITORY}" \
              --add-label "completed"
          elif [[ "${CODEX_EXIT}" != "0" ]]; then
            gh issue comment "${ISSUE_NUMBER}" --repo "${GITHUB_REPOSITORY}" \
              --body "Codex implementation stopped before PR creation because mandatory protocol checks failed.

          Exit code: ${CODEX_EXIT}
          Check artifacts for protocol reports and codex output log."
            gh issue edit "${ISSUE_NUMBER}" --repo "${GITHUB_REPOSITORY}" \
              --add-label "needs-review"
          else
            gh issue comment "${ISSUE_NUMBER}" --repo "${GITHUB_REPOSITORY}" \
              --body "Codex implementation did not produce changes.

          Exit code: ${CODEX_EXIT}
          This may mean: no code changes were needed, the task was unclear, or Codex encountered an error.

          Check the workflow run artifacts for the full Codex output log."
            gh issue edit "${ISSUE_NUMBER}" --repo "${GITHUB_REPOSITORY}" \
              --add-label "needs-review"
          fi

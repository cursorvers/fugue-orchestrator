name: line-capture-userid (one-time)

on:
  workflow_dispatch:
    inputs:
      wait_seconds:
        description: "Seconds to wait for user to send a message"
        default: "90"

permissions:
  contents: read

jobs:
  capture:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Capture LINE userId via temp webhook
        env:
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          CAPTURE_URL: "https://haaxgwyimoqzzxzdaeep.supabase.co/functions/v1/line-userid-capture"
          WAIT_SECONDS: ${{ inputs.wait_seconds }}
        run: |
          set -euo pipefail

          echo "=== Step 0: Warm up the capture function ==="
          curl -sS "${CAPTURE_URL}" | jq . || true
          sleep 2
          curl -sS "${CAPTURE_URL}" | jq . || true
          sleep 2

          echo ""
          echo "=== Step 0.5: LINE webhook test to capture function ==="
          curl -sS -X POST https://api.line.me/v2/bot/channel/webhook/test \
            -H "Authorization: Bearer ${LINE_CHANNEL_ACCESS_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"endpoint\": \"${CAPTURE_URL}\"}" | jq .

          echo ""
          echo "=== Step 1: Get current webhook URL ==="
          CURRENT=$(curl -sS https://api.line.me/v2/bot/channel/webhook/endpoint \
            -H "Authorization: Bearer ${LINE_CHANNEL_ACCESS_TOKEN}")
          echo "Current webhook config: $CURRENT"
          ORIGINAL_URL=$(echo "$CURRENT" | jq -r '.endpoint')
          echo "Original URL: $ORIGINAL_URL"

          echo ""
          echo "=== Step 2: Set webhook to temp capture function ==="
          curl -sS -X PUT https://api.line.me/v2/bot/channel/webhook/endpoint \
            -H "Authorization: Bearer ${LINE_CHANNEL_ACCESS_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"endpoint\": \"${CAPTURE_URL}\"}" | jq .

          echo ""
          echo "=== Step 3: Verify new webhook ==="
          curl -sS https://api.line.me/v2/bot/channel/webhook/endpoint \
            -H "Authorization: Bearer ${LINE_CHANNEL_ACCESS_TOKEN}" | jq .

          echo ""
          echo "============================================"
          echo "  SEND A MESSAGE TO @529ybhfo NOW!"
          echo "  Waiting ${WAIT_SECONDS} seconds..."
          echo "============================================"
          sleep "${WAIT_SECONDS}"

          echo ""
          echo "=== Step 4: Restore original webhook URL ==="
          curl -sS -X PUT https://api.line.me/v2/bot/channel/webhook/endpoint \
            -H "Authorization: Bearer ${LINE_CHANNEL_ACCESS_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"endpoint\": \"${ORIGINAL_URL}\"}" | jq .

          echo ""
          echo "=== Step 5: Verify restored webhook ==="
          curl -sS https://api.line.me/v2/bot/channel/webhook/endpoint \
            -H "Authorization: Bearer ${LINE_CHANNEL_ACCESS_TOKEN}" | jq .

          echo ""
          echo "=== Done! Check Supabase line_events for userid_capture entries ==="
